<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Laravel服务容器的绑定与解析' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Laravel服务容器的绑定与解析</center></div><div class='banquan'>原文出处:本文由博客园博主it-world提供。<br/>
原文连接:https://www.cnblogs.com/it-3327/p/11795559.html</div><br>
    <p>本篇文章给大家带来的内容是关于Laravel服务容器的绑定与解析，有一定的参考价值，有需要的朋友可以参考一下，希望对你有所帮助。</p>
<p><strong>前言</strong></p>
<p>&emsp; 老实说，第一次老大让我看laravel框架手册的那天早上，我是很绝望的，因为真的没接触过，对我这种渣渣来说，laravel的入门门槛确实有点高了，但还是得硬着头皮看下去（虽然到现在我还有很多没看懂，也没用过）。<br />&emsp; 后面慢慢根据公司项目的代码对laravel也慢慢熟悉起来了，但还是停留在一些表面的功能，例如依赖注入，ORM操作，用户认证这些和我项目业务逻辑相关的操作，然后对于一些架构基础的，例如服务提供器，服务容器，中间件，Redis等这些一开始就要设置好的东西，我倒是没实际操作过（因为老大一开始就做好了），所以看手册还是有点懵。<br />&emsp; 所以有空的时候逛逛论坛，搜下Google就发现许多关于laravel核心架构的介绍，以及如何使用的网站（确实看完后再去看手册就好理解多了），下面就根据一个我觉得不错的网站上面的教学来记录一下laravel核心架构的学习<br />网站地址：https://laraweb.net/ 这是一个日本的网站，我觉得挺适合新手的，内容用浏览器翻译过来就ok了，毕竟日文直翻过来很好理解的</p>
<p><strong>关于服务容器</strong></p>
<p>&emsp; 手册上是这样介绍的：Laravel 服务容器是用于管理类的依赖和执行依赖注入的工具。依赖注入这个花俏名词实质上是指：类的依赖项通过构造函数，或者某些情况下通过「setter」方法「注入」到类中。。。。。。（真的看不懂啥意思）<br />&emsp; 服务容器是用于管理类（服务）的实例化的机制。直接看看服务容器怎么用</p>
<p>&emsp; 1.在服务容器中注册类（bind）</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$this</code><code class="php plain">-&gt;app-&gt;bind(</code><code class="php string">'sender'</code><code class="php plain">,</code><code class="php string">'MailSender'</code><code class="php plain">);</code></p>
<p class="line number2 index1 alt1"><code class="php comments">//$this-&gt;app成为服务容器。</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 2.从服务容器生成类（make）</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$sender</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;app-&gt;make(</code><code class="php string">'sender'</code><code class="php plain">);</code></p>
<p class="line number2 index1 alt1"><code class="php comments">//从服务容器（$this-&gt;app）创建一个sender类。</code></p>
<p class="line number3 index2 alt2"><code class="php plain">在这种情况下，将返回MailSender的实例。</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 这是服务容器最简单的使用，下面是对服务容器的详细介绍</p>
<p><strong>laravel容器基本认识</strong></p>
<p>&emsp; 一开始，index.php 文件加载 Composer 生成定义的自动加载器，然后从 bootstrap/app.php 脚本中检索 Laravel 应用程序的实例。Laravel 本身采取的第一个动作是创建一个 application/ service container 的实例。</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$app</code> <code class="php plain">= </code><code class="php keyword">new</code> <code class="php plain">Illuminate\Foundation\Application(</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">dirname(__DIR__)</code></p>
<p class="line number3 index2 alt2"><code class="php plain">);</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 这个文件在每一次请求到达laravel框架都会执行，所创建的$app即是laravel框架的应用程序实例，它在整个请求生命周期都是唯一的。laravel提供了很多服务，包括认证，数据库，缓存，消息队列等等，$app作为一个容器管理工具，负责几乎所有服务组件的实例化以及实例的生命周期管理。当需要一个服务类来完成某个功能的时候，仅需要通过容器解析出该类型的一个实例即可。从最终的使用方式来看，laravel容器对服务实例的管理主要包括以下几个方面：</p>
<ul class=" list-paddingleft-2">
<li>
<p><strong>服务的绑定与解析</strong></p>


</li>
<li>
<p><strong>服务提供者的管理</strong></p>


</li>
<li>
<p><strong>别名的作用</strong></p>


</li>
<li>
<p><strong>依赖注入</strong></p>


</li>


</ul>
<p>先了解如何在代码中获取到容器实例，再学习上面四个关键</p>
<h4>如何在代码中获取到容器实例</h4>
<p>第一种是</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$app</code> <code class="php plain">= app();</code></p>
<p class="line number2 index1 alt1"><code class="php comments">//app这个辅助函数定义在\vendor\laravel\framework\src\Illuminate\Foundation\helper.php</code></p>
<p class="line number3 index2 alt2"><code class="php plain">里面，，这个文件定义了很多help函数，并且会通过composer自动加载到项目中。</code></p>
<p class="line number4 index3 alt1"><code class="php plain">所以，在参与http请求处理的任何代码位置都能够访问其中的函数，比如app()。</code></p>





</td>


</tr>


</tbody>


</table>
<p>第二种是</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php plain">Route::get(</code><code class="php string">'/'</code><code class="php plain">, </code><code class="php keyword">function</code> <code class="php plain">() {</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">dd(App::basePath());</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php string">''</code><code class="php plain">;</code></p>
<p class="line number4 index3 alt1"><code class="php plain">});</code></p>
<p class="line number5 index4 alt2"><code class="php comments">//这个其实是用到Facade，中文直译貌似叫门面，在config/app.php中，</code></p>
<p class="line number6 index5 alt1"><code class="php plain">有一节数组aliases专门用来配置一些类型的别名，第一个就是</code><code class="php string">'App'</code> <code class="php plain">=&gt; Illuminate\Support\Facades\App::</code><code class="php keyword">class</code><code class="php plain">,</code></p>
<p class="line number7 index6 alt2"><code class="php plain">具体的Google一下laravel有关门面的具体实现方式</code></p>





</td>


</tr>


</tbody>


</table>
<p>第三种是</p>
<p>&emsp; 在服务提供者里面直接使用$this-&gt;app。服务提供者后面还会介绍，现在只是引入。因为服务提供者类都是由laravel容器实例化的，这些类都继承自Illuminate\Support\ServiceProvider，它定义了一个实例属性$app：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php keyword">abstract</code> <code class="php keyword">class</code> <code class="php plain">ServiceProvider</code></p>
<p class="line number2 index1 alt1"><code class="php plain">{</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">protected</code> <code class="php variable">$app</code><code class="php plain">;</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; laravel在实例化服务提供者的时候，会把laravel容器实例注入到这个$app上面。所以我们在服务提供者里面，始终能通过$this-&gt;$app访问到laravel容器实例，而不需要再使用app()函数或者App Facade了。</p>
<p><img src="./images/Laravel服务容器的绑定与解析0.jpg" alt="" /><img src="./images/Laravel服务容器的绑定与解析1.jpg" alt="" /><img src="./images/Laravel服务容器的绑定与解析2.jpg" alt="" /></p>
<p>链接：<a href="https://pan.baidu.com/s/1v5gm7n0L7TGyejCmQrMh2g" target="_blank">https://pan.baidu.com/s/1v5gm7n0L7TGyejCmQrMh2g</a>&nbsp;提取码：x2p5<br /><br />免费分享，但是X度限制严重，如若链接失效点击链接或搜索加群 群号<a href="https://jq.qq.com/?_wv=1027&amp;k=5Qtjg0V" target="_blank">518475424</a>。</p>
<h4>如何理解服务绑定与解析</h4>
<p>&emsp; 浅义层面理解，容器既然用来存储对象，那么就要有一个对象存入跟对象取出的过程。这个对象存入跟对象取出的过程在laravel里面称为服务的绑定与解析。</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php plain">app()-&gt;bind(</code><code class="php string">'service'</code><code class="php plain">, </code><code class="php string">'this is service1'</code><code class="php plain">);</code></p>
<p class="line number2 index1 alt1">&nbsp;</p>
<p class="line number3 index2 alt2"><code class="php plain">app()-&gt;bind(</code><code class="php string">'service2'</code><code class="php plain">, [</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'hi'</code> <code class="php plain">=&gt; </code><code class="php keyword">function</code><code class="php plain">(){</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//say hi</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number7 index6 alt2"><code class="php plain">]);</code></p>
<p class="line number8 index7 alt1">&nbsp;</p>
<p class="line number9 index8 alt2"><code class="php keyword">class</code> <code class="php plain">Service {</code></p>
<p class="line number10 index9 alt1">&nbsp;</p>
<p class="line number11 index10 alt2"><code class="php plain">}</code></p>
<p class="line number12 index11 alt1">&nbsp;</p>
<p class="line number13 index12 alt2"><code class="php plain">app()-&gt;bind(</code><code class="php string">'service3'</code><code class="php plain">, </code><code class="php keyword">function</code><code class="php plain">(){</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php keyword">new</code> <code class="php plain">Service();</code></p>
<p class="line number15 index14 alt2"><code class="php plain">});</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 还有一个单例绑定singleton，是bind的一种特殊情况（第三个参数为true）,绑定到容器的对象只会被解析一次，之后的调用都返回相同的实例</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">singleton(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$concrete</code> <code class="php plain">= null)</code></p>
<p class="line number2 index1 alt1"><code class="php plain">{</code></p>
<p class="line number3 index2 alt2"><code class="php variable">$this</code><code class="php plain">-&gt;bind(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$concrete</code><code class="php plain">, true);</code></p>
<p class="line number4 index3 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 在绑定的时候，我们可以直接绑定已经初始化好的数据（基本类型、数组、对象实例），还可以用匿名函数来绑定。用匿名函数的好处在于，这个服务绑定到容器以后，并不会立即产生服务最终的对象，只有在这个服务解析的时候，匿名函数才会执行，此时才会产生这个服务对应的服务实例。<br />&emsp; 实际上，当我们使用singleton，bind方法以及数组形式，（这三个方法是后面要介绍的绑定的方法），进行服务绑定的时候，如果绑定的服务形式，不是一个匿名函数，也会在laravel内部用一个匿名函数包装起来，这样的话， 不轮绑定什么内容，都能做到前面介绍的懒初始化的功能，这对于容器的性能是有好处的。这个可以从bind的源码中看到一些细节：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php keyword">if</code> <code class="php plain">(! </code><code class="php variable">$concrete</code> <code class="php keyword">instanceof</code> <code class="php plain">Closure) {</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$concrete</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getClosure(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number3 index2 alt2"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>看看bind的底层代码</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">bind(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$concrete</code> <code class="php plain">= null, </code><code class="php variable">$shared</code> <code class="php plain">= false)</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 第一个参数服务绑定名称，第二个参数服务绑定的结果（也就是闭包，得到实例），第三个参数就表示这个服务是否在多次解析的时候，始终返回第一次解析出的实例（也就是单例绑定singleton）。</p>
<p>&emsp; 服务绑定还可以通过数组的方式：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php plain">app()[</code><code class="php string">'service'</code><code class="php plain">] = </code><code class="php keyword">function</code><code class="php plain">(){</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php keyword">new</code> <code class="php plain">Service();</code></p>
<p class="line number3 index2 alt2"><code class="php plain">};</code></p>





</td>


</tr>


</tbody>


</table>
<p>绑定大概就这些，接下来看解析，也就是取出来用</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$service</code><code class="php plain">= app()-&gt;make(</code><code class="php string">'service'</code><code class="php plain">);</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 这个方法接收两个参数，第一个是服务的绑定名称和服务绑定名称的别名，如果是别名，那么就会根据服务绑定名称的别名配置，找到最终的服务绑定名称，然后进行解析；第二个参数是一个数组，最终会传递给服务绑定产生的闭包。</p>
<p>看源码：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>
<p class="line number35 index34 alt2">35</p>
<p class="line number36 index35 alt1">36</p>
<p class="line number37 index36 alt2">37</p>
<p class="line number38 index37 alt1">38</p>
<p class="line number39 index38 alt2">39</p>
<p class="line number40 index39 alt1">40</p>
<p class="line number41 index40 alt2">41</p>
<p class="line number42 index41 alt1">42</p>
<p class="line number43 index42 alt2">43</p>
<p class="line number44 index43 alt1">44</p>
<p class="line number45 index44 alt2">45</p>
<p class="line number46 index45 alt1">46</p>
<p class="line number47 index46 alt2">47</p>
<p class="line number48 index47 alt1">48</p>
<p class="line number49 index48 alt2">49</p>
<p class="line number50 index49 alt1">50</p>
<p class="line number51 index50 alt2">51</p>
<p class="line number52 index51 alt1">52</p>
<p class="line number53 index52 alt2">53</p>
<p class="line number54 index53 alt1">54</p>
<p class="line number55 index54 alt2">55</p>
<p class="line number56 index55 alt1">56</p>
<p class="line number57 index56 alt2">57</p>
<p class="line number58 index57 alt1">58</p>
<p class="line number59 index58 alt2">59</p>
<p class="line number60 index59 alt1">60</p>
<p class="line number61 index60 alt2">61</p>
<p class="line number62 index61 alt1">62</p>
<p class="line number63 index62 alt2">63</p>
<p class="line number64 index63 alt1">64</p>
<p class="line number65 index64 alt2">65</p>
<p class="line number66 index65 alt1">66</p>
<p class="line number67 index66 alt2">67</p>
<p class="line number68 index67 alt1">68</p>
<p class="line number69 index68 alt2">69</p>
<p class="line number70 index69 alt1">70</p>
<p class="line number71 index70 alt2">71</p>
<p class="line number72 index71 alt1">72</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">/**</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* Resolve the given type from the container.</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; string&nbsp; $abstract</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; array&nbsp; $parameters</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @return mixed</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number8 index7 alt1"><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">make(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php keyword">array</code> <code class="php variable">$parameters</code> <code class="php plain">= [])</code></p>
<p class="line number9 index8 alt2"><code class="php plain">{</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$this</code><code class="php plain">-&gt;resolve(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$parameters</code><code class="php plain">);</code></p>
<p class="line number11 index10 alt2"><code class="php plain">}</code></p>
<p class="line number12 index11 alt1">&nbsp;</p>
<p class="line number13 index12 alt2"><code class="php comments">/**</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* Resolve the given type from the container.</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; string&nbsp; $abstract</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; array&nbsp; $parameters</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @return mixed</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number20 index19 alt1"><code class="php keyword">protected</code> <code class="php keyword">function</code> <code class="php plain">resolve(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$parameters</code> <code class="php plain">= [])</code></p>
<p class="line number21 index20 alt2"><code class="php plain">{</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$abstract</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getAlias(</code><code class="php variable">$abstract</code><code class="php plain">);</code></p>
<p class="line number23 index22 alt2">&nbsp;</p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$needsContextualBuild</code> <code class="php plain">= ! </code><code class="php functions">empty</code><code class="php plain">(</code><code class="php variable">$parameters</code><code class="php plain">) || ! </code><code class="php functions">is_null</code><code class="php plain">(</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;getContextualConcrete(</code><code class="php variable">$abstract</code><code class="php plain">)</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">);</code></p>
<p class="line number27 index26 alt2">&nbsp;</p>
<p class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If an instance of the type is currently being managed as a singleton we'll</code></p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// just return an existing instance instead of instantiating new instances</code></p>
<p class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// so the developer can keep using the same objects instance every time.</code></p>
<p class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(isset(</code><code class="php variable">$this</code><code class="php plain">-&gt;instances[</code><code class="php variable">$abstract</code><code class="php plain">]) &amp;&amp; ! </code><code class="php variable">$needsContextualBuild</code><code class="php plain">) {</code></p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$this</code><code class="php plain">-&gt;instances[</code><code class="php variable">$abstract</code><code class="php plain">];</code></p>
<p class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number34 index33 alt1">&nbsp;</p>
<p class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;with[] = </code><code class="php variable">$parameters</code><code class="php plain">;</code></p>
<p class="line number36 index35 alt1">&nbsp;</p>
<p class="line number37 index36 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$concrete</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getConcrete(</code><code class="php variable">$abstract</code><code class="php plain">);</code></p>
<p class="line number38 index37 alt1">&nbsp;</p>
<p class="line number39 index38 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// We're ready to instantiate an instance of the concrete type registered for</code></p>
<p class="line number40 index39 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// the binding. This will instantiate the types, as well as resolve any of</code></p>
<p class="line number41 index40 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// its "nested" dependencies recursively until all have gotten resolved.</code></p>
<p class="line number42 index41 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;isBuildable(</code><code class="php variable">$concrete</code><code class="php plain">, </code><code class="php variable">$abstract</code><code class="php plain">)) {</code></p>
<p class="line number43 index42 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$object</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;build(</code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number44 index43 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">} </code><code class="php keyword">else</code> <code class="php plain">{</code></p>
<p class="line number45 index44 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$object</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;make(</code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number46 index45 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number47 index46 alt2">&nbsp;</p>
<p class="line number48 index47 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If we defined any extenders for this type, we'll need to spin through them</code></p>
<p class="line number49 index48 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// and apply them to the object being built. This allows for the extension</code></p>
<p class="line number50 index49 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// of services, such as changing configuration or decorating the object.</code></p>
<p class="line number51 index50 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">foreach</code> <code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;getExtenders(</code><code class="php variable">$abstract</code><code class="php plain">) </code><code class="php keyword">as</code> <code class="php variable">$extender</code><code class="php plain">) {</code></p>
<p class="line number52 index51 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$object</code> <code class="php plain">= </code><code class="php variable">$extender</code><code class="php plain">(</code><code class="php variable">$object</code><code class="php plain">, </code><code class="php variable">$this</code><code class="php plain">);</code></p>
<p class="line number53 index52 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number54 index53 alt1">&nbsp;</p>
<p class="line number55 index54 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If the requested type is registered as a singleton we'll want to cache off</code></p>
<p class="line number56 index55 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// the instances in "memory" so we can return it later without creating an</code></p>
<p class="line number57 index56 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// entirely new instance of an object on each subsequent request for it.</code></p>
<p class="line number58 index57 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;isShared(</code><code class="php variable">$abstract</code><code class="php plain">) &amp;&amp; ! </code><code class="php variable">$needsContextualBuild</code><code class="php plain">) {</code></p>
<p class="line number59 index58 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;instances[</code><code class="php variable">$abstract</code><code class="php plain">] = </code><code class="php variable">$object</code><code class="php plain">;</code></p>
<p class="line number60 index59 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number61 index60 alt2">&nbsp;</p>
<p class="line number62 index61 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;fireResolvingCallbacks(</code><code class="php variable">$abstract</code><code class="php plain">, </code><code class="php variable">$object</code><code class="php plain">);</code></p>
<p class="line number63 index62 alt2">&nbsp;</p>
<p class="line number64 index63 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Before returning, we will also set the resolved flag to "true" and pop off</code></p>
<p class="line number65 index64 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// the parameter overrides for this build. After those two things are done</code></p>
<p class="line number66 index65 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// we will be ready to return back the fully constructed class instance.</code></p>
<p class="line number67 index66 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;resolved[</code><code class="php variable">$abstract</code><code class="php plain">] = true;</code></p>
<p class="line number68 index67 alt1">&nbsp;</p>
<p class="line number69 index68 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">array_pop</code><code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;with);</code></p>
<p class="line number70 index69 alt1">&nbsp;</p>
<p class="line number71 index70 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$object</code><code class="php plain">;</code></p>
<p class="line number72 index71 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>第一步：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$needsContextualBuild</code> <code class="php plain">= ! </code><code class="php functions">empty</code><code class="php plain">(</code><code class="php variable">$parameters</code><code class="php plain">) || ! </code><code class="php functions">is_null</code><code class="php plain">(</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;getContextualConcrete(</code><code class="php variable">$abstract</code><code class="php plain">)</code></p>
<p class="line number3 index2 alt2"><code class="php plain">);</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 该方法主要是区分，解析的对象是否有参数，如果有参数，还需要对参数做进一步的分析，因为传入的参数，也可能是依赖注入的，所以还需要对传入的参数进行解析；这个后面再分析。</p>
<p>第二步：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php keyword">if</code> <code class="php plain">(isset(</code><code class="php variable">$this</code><code class="php plain">-&gt;instances[</code><code class="php variable">$abstract</code><code class="php plain">]) &amp;&amp; ! </code><code class="php variable">$needsContextualBuild</code><code class="php plain">) {</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$this</code><code class="php plain">-&gt;instances[</code><code class="php variable">$abstract</code><code class="php plain">];</code></p>
<p class="line number3 index2 alt2"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 如果是绑定的单例，并且不需要上面的参数依赖。我们就可以直接返回 $this-&gt;instances[$abstract]。</p>
<p>第三步：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php variable">$concrete</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getConcrete(</code><code class="php variable">$abstract</code><code class="php plain">);</code></p>
<p class="line number2 index1 alt1">&nbsp;</p>
<p class="line number3 index2 alt2"><code class="php plain">...</code></p>
<p class="line number4 index3 alt1">&nbsp;</p>
<p class="line number5 index4 alt2"><code class="php comments">/**</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* Get the concrete type for a given abstract.</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; string&nbsp; $abstract</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @return mixed&nbsp;&nbsp; $concrete</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number11 index10 alt2"><code class="php keyword">protected</code> <code class="php keyword">function</code> <code class="php plain">getConcrete(</code><code class="php variable">$abstract</code><code class="php plain">)</code></p>
<p class="line number12 index11 alt1"><code class="php plain">{</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(! </code><code class="php functions">is_null</code><code class="php plain">(</code><code class="php variable">$concrete</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getContextualConcrete(</code><code class="php variable">$abstract</code><code class="php plain">))) {</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$concrete</code><code class="php plain">;</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number16 index15 alt1">&nbsp;</p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If we don't have a registered resolver or concrete for the type, we'll just</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// assume each type is a concrete name and will attempt to resolve it as is</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// since the container should be able to resolve concretes automatically.</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(isset(</code><code class="php variable">$this</code><code class="php plain">-&gt;bindings[</code><code class="php variable">$abstract</code><code class="php plain">])) {</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$this</code><code class="php plain">-&gt;bindings[</code><code class="php variable">$abstract</code><code class="php plain">][</code><code class="php string">'concrete'</code><code class="php plain">];</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number23 index22 alt2">&nbsp;</p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$abstract</code><code class="php plain">;</code></p>
<p class="line number25 index24 alt2"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 这一步主要是先从绑定的上下文找，是不是可以找到绑定类；如果没有，则再从 $bindings[] 中找关联的实现类；最后还没有找到的话，就直接返回 $abstract 本身。</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">// We're ready to instantiate an instance of the concrete type registered for</code></p>
<p class="line number2 index1 alt1"><code class="php comments">// the binding. This will instantiate the types, as well as resolve any of</code></p>
<p class="line number3 index2 alt2"><code class="php comments">// its "nested" dependencies recursively until all have gotten resolved.</code></p>
<p class="line number4 index3 alt1"><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;isBuildable(</code><code class="php variable">$concrete</code><code class="php plain">, </code><code class="php variable">$abstract</code><code class="php plain">)) {</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$object</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;build(</code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number6 index5 alt1"><code class="php plain">} </code><code class="php keyword">else</code> <code class="php plain">{</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$object</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;make(</code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number8 index7 alt1"><code class="php plain">}</code></p>
<p class="line number9 index8 alt2">&nbsp;</p>
<p class="line number10 index9 alt1"><code class="php plain">...</code></p>
<p class="line number11 index10 alt2">&nbsp;</p>
<p class="line number12 index11 alt1"><code class="php comments">/**</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* Determine if the given concrete is buildable.</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; mixed&nbsp;&nbsp; $concrete</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; string&nbsp; $abstract</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @return bool</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number19 index18 alt2"><code class="php keyword">protected</code> <code class="php keyword">function</code> <code class="php plain">isBuildable(</code><code class="php variable">$concrete</code><code class="php plain">, </code><code class="php variable">$abstract</code><code class="php plain">)</code></p>
<p class="line number20 index19 alt1"><code class="php plain">{</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$concrete</code> <code class="php plain">=== </code><code class="php variable">$abstract</code> <code class="php plain">|| </code><code class="php variable">$concrete</code> <code class="php keyword">instanceof</code> <code class="php plain">Closure;</code></p>
<p class="line number22 index21 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>&emsp; 如果之前找到的 $concrete 返回的是 $abstract 值，或者 $concrete 是个闭包，则执行 $this-&gt;build($concrete)，否则，表示存在嵌套依赖的情况，则采用递归的方法执行 $this-&gt;make($concrete)，直到所有的都解析完为止。</p>
<p><em>$this-&gt;build($concrete)</em></p>
<p>&nbsp;</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>
<p class="line number35 index34 alt2">35</p>
<p class="line number36 index35 alt1">36</p>
<p class="line number37 index36 alt2">37</p>
<p class="line number38 index37 alt1">38</p>
<p class="line number39 index38 alt2">39</p>
<p class="line number40 index39 alt1">40</p>
<p class="line number41 index40 alt2">41</p>
<p class="line number42 index41 alt1">42</p>
<p class="line number43 index42 alt2">43</p>
<p class="line number44 index43 alt1">44</p>
<p class="line number45 index44 alt2">45</p>
<p class="line number46 index45 alt1">46</p>
<p class="line number47 index46 alt2">47</p>
<p class="line number48 index47 alt1">48</p>
<p class="line number49 index48 alt2">49</p>
<p class="line number50 index49 alt1">50</p>
<p class="line number51 index50 alt2">51</p>
<p class="line number52 index51 alt1">52</p>
<p class="line number53 index52 alt2">53</p>
<p class="line number54 index53 alt1">54</p>
<p class="line number55 index54 alt2">55</p>
<p class="line number56 index55 alt1">56</p>
<p class="line number57 index56 alt2">57</p>
<p class="line number58 index57 alt1">58</p>
<p class="line number59 index58 alt2">59</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">/**</code></p>
<p class="line number2 index1 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* Instantiate a concrete instance of the given type.</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param&nbsp; string&nbsp; $concrete</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @return mixed</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @throws \Illuminate\Contracts\Container\BindingResolutionException</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number9 index8 alt2"><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">build(</code><code class="php variable">$concrete</code><code class="php plain">)</code></p>
<p class="line number10 index9 alt1"><code class="php plain">{</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If the concrete type is actually a Closure, we will just execute it and</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// hand back the results of the functions, which allows functions to be</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// used as resolvers for more fine-tuned resolution of these objects.</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 如果传入的是闭包，则直接执行闭包函数，返回结果</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$concrete</code> <code class="php keyword">instanceof</code> <code class="php plain">Closure) {</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$concrete</code><code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">, </code><code class="php variable">$this</code><code class="php plain">-&gt;getLastParameterOverride());</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number18 index17 alt1">&nbsp;</p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 利用反射机制，解析该类。</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$reflector</code> <code class="php plain">= </code><code class="php keyword">new</code> <code class="php plain">ReflectionClass(</code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number21 index20 alt2">&nbsp;</p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If the type is not instantiable, the developer is attempting to resolve</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// an abstract type such as an Interface of Abstract Class and there is</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// no binding registered for the abstractions so we need to bail out.</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(! </code><code class="php variable">$reflector</code><code class="php plain">-&gt;isInstantiable()) {</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$this</code><code class="php plain">-&gt;notInstantiable(</code><code class="php variable">$concrete</code><code class="php plain">);</code></p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number28 index27 alt1">&nbsp;</p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;buildStack[] = </code><code class="php variable">$concrete</code><code class="php plain">;</code></p>
<p class="line number30 index29 alt1">&nbsp;</p>
<p class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 获取构造函数</code></p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$constructor</code> <code class="php plain">= </code><code class="php variable">$reflector</code><code class="php plain">-&gt;getConstructor();</code></p>
<p class="line number33 index32 alt2">&nbsp;</p>
<p class="line number34 index33 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// If there are no constructors, that means there are no dependencies then</code></p>
<p class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// we can just resolve the instances of the objects right away, without</code></p>
<p class="line number36 index35 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// resolving any other types or dependencies out of these containers.</code></p>
<p class="line number37 index36 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 如果没有构造函数，则表明没有传入参数，也就意味着不需要做对应的上下文依赖解析。</code></p>
<p class="line number38 index37 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php functions">is_null</code><code class="php plain">(</code><code class="php variable">$constructor</code><code class="php plain">)) {</code></p>
<p class="line number39 index38 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 将 build 过程的内容 pop，然后直接构造对象输出。</code></p>
<p class="line number40 index39 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">array_pop</code><code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;buildStack);</code></p>
<p class="line number41 index40 alt2">&nbsp;</p>
<p class="line number42 index41 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php keyword">new</code> <code class="php variable">$concrete</code><code class="php plain">;</code></p>
<p class="line number43 index42 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number44 index43 alt1">&nbsp;</p>
<p class="line number45 index44 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 获取构造函数的参数</code></p>
<p class="line number46 index45 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$dependencies</code> <code class="php plain">= </code><code class="php variable">$constructor</code><code class="php plain">-&gt;getParameters();</code></p>
<p class="line number47 index46 alt2">&nbsp;</p>
<p class="line number48 index47 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Once we have all the constructor's parameters we can create each of the</code></p>
<p class="line number49 index48 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// dependency instances and then use the reflection instances to make a</code></p>
<p class="line number50 index49 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// new instance of this class, injecting the created dependencies in.</code></p>
<p class="line number51 index50 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// 解析出所有上下文依赖对象，带入函数，构造对象输出</code></p>
<p class="line number52 index51 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$instances</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;resolveDependencies(</code></p>
<p class="line number53 index52 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$dependencies</code></p>
<p class="line number54 index53 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">);</code></p>
<p class="line number55 index54 alt2">&nbsp;</p>
<p class="line number56 index55 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php functions">array_pop</code><code class="php plain">(</code><code class="php variable">$this</code><code class="php plain">-&gt;buildStack);</code></p>
<p class="line number57 index56 alt2">&nbsp;</p>
<p class="line number58 index57 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$reflector</code><code class="php plain">-&gt;newInstanceArgs(</code><code class="php variable">$instances</code><code class="php plain">);</code></p>
<p class="line number59 index58 alt2"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>

</table>

</div></div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>