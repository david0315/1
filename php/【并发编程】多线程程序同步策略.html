<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®ã€å¹¶å‘ç¼–ç¨‹ã€‘å¤šçº¿ç¨‹ç¨‹åºåŒæ­¥ç­–ç•¥' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>ã€å¹¶å‘ç¼–ç¨‹ã€‘å¤šçº¿ç¨‹ç¨‹åºåŒæ­¥ç­–ç•¥</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»bigospriteæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/bigosprite/p/11332389.html</div><br>
    <src class="toc">
    <p class="toc-title">ç›®å½•</p>
    <src class="toc-list">
        <ul>
        <li><a href="#c11çº¿ç¨‹ä½¿ç”¨åˆæ¢">C++11çº¿ç¨‹ä½¿ç”¨åˆæ¢</a></li>
        <li><a href="#é‡‡ç”¨æ¡ä»¶å˜é‡ç­‰å¾…æŸä¸ªäº‹ä»¶æˆ–æ¡ä»¶å‘ç”Ÿ">é‡‡ç”¨æ¡ä»¶å˜é‡ç­‰å¾…æŸä¸ªäº‹ä»¶æˆ–æ¡ä»¶å‘ç”Ÿ</a></li>
        <li><a href="#çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—é€‚é…å™¨">çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—é€‚é…å™¨</a></li>
        </ul>
    

<h2 id="c11çº¿ç¨‹ä½¿ç”¨åˆæ¢">C++11çº¿ç¨‹ä½¿ç”¨åˆæ¢</h2>
<p><code>std::thread</code></p>
<pre><code><code>#include &lt;thread&gt;</code></code></pre>
<p>åªè¯»çš„å…±äº«æ•°æ®åœ¨å¤šä¸ªçº¿ç¨‹é—´ä¸å­˜åœ¨Race conditionçš„å±é™©ï¼Œè€Œå¯è¯»å¯å†™å…±äº«æ•°æ®åœ¨çº¿ç¨‹é—´å…±äº«æ—¶åˆ™éœ€åšå¥½çº¿ç¨‹åŒæ­¥ï¼Œå³æ•°æ®ä¿æŠ¤ï¼Œä¸»è¦åŒ…æ‹¬lock-basedå’Œlock-freeç­–ç•¥ã€‚</p>
<p>å¸¸è§çš„ä»¥äº’æ–¥é”ä¿æŠ¤å¤šçº¿ç¨‹é—´çš„å…±äº«æ•°æ®ï¼Œä¿è¯æŸä¸€æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«æ•°æ®ï¼Œå¯¼è‡´çº¿ç¨‹é—´æ•°æ®ä¿æŠ¤æ˜¯ä¸²è¡Œï¼Œå› æ­¤åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œé”ä¿æŠ¤çš„åŒºåŸŸè¶Šå°ï¼Œå¹¶å‘ç¨‹åº¦è¶Šé«˜ã€‚</p>
<h2 id="é‡‡ç”¨æ¡ä»¶å˜é‡ç­‰å¾…æŸä¸ªäº‹ä»¶æˆ–æ¡ä»¶å‘ç”Ÿ">é‡‡ç”¨æ¡ä»¶å˜é‡ç­‰å¾…æŸä¸ªäº‹ä»¶æˆ–æ¡ä»¶å‘ç”Ÿ</h2>
<p>C++11æä¾›äº†ä¸¤ç§æ¡ä»¶å˜é‡ï¼šstd::condition_variableå’Œstd::condition_variable_anyï¼Œå‡éœ€è¦å’Œäº’æ–¥é‡ä¸€èµ·ä½¿ç”¨æ¥ä¿è¯æ“ä½œçš„åŒæ­¥æ€§ã€‚å‰è€…ä»…èƒ½ä¸std::mutexä¸€èµ·ä½¿ç”¨ï¼Œåè€…å¯ä¸æ‰€æœ‰mutex-likeçš„é”ä¸€èµ·ä½¿ç”¨ï¼Œæ›´åŠ é€šç”¨ï¼Œä½†ä»¥ç‰ºç‰²ç©ºé—´ã€æ€§èƒ½æˆ–æ“ä½œç³»ç»Ÿèµ„æºä¸ºä»£ä»·ï¼Œå› æ­¤std::condition_variableæ˜¯é¦–é€‰ï¼›å®ƒä»¬å‡åœ¨<condition_variable>å¤´æ–‡ä»¶ä¸­å®šä¹‰ã€‚</p>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼åœ¨å¹¶å‘ç¼–ç¨‹ä¸­åº”ç”¨å¹¿æ³›ï¼Œæœ‰åŠ©äºç³»ç»Ÿçš„è§£è€¦ã€‚é˜Ÿåˆ—æ˜¯ä¸€ç§å¸¸è§çš„åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹é—´ä¼ é€’æ•°æ®çš„å®¹å™¨ï¼Œé˜Ÿåˆ—å…ˆå…¥å…ˆå‡ºçš„ç‰¹æ€§æ»¡è¶³åº”ç”¨å¯¹é¡ºåºæ€§çš„è¦æ±‚ã€‚</p>
<p>äººè„¸åˆ†æç»„ä»¶é‡‡ç”¨é˜Ÿåˆ—ä¼ é€’æ•°æ®ï¼Œé€šè¿‡åœ¨ç”Ÿäº§è€…çº¿ç¨‹ä¸­è°ƒç”¨InputDataå‡½æ•°å°†å¾…åˆ†ææ•°æ®åŒ…é€å…¥é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨notify_oneé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä»è€Œæ¶ˆè´¹è€…çº¿ç¨‹è¿›è¡Œäººè„¸æ•°æ®åˆ†æã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code><code>std::mutex mut;
std::condition_variable cond;
std::queue&lt;data_chunk&gt; data_queue;

// å°†å¾…åˆ†ææ•°æ®é€å…¥é˜Ÿåˆ—
int InputData(const data_chunk&amp; data)
{
  if (invalid_data)
  {
    LOG_ERROR(&quot;invalid param!&quot;);
    return ERROR_CODE;
  }
  // å°†æ•°æ®é€å…¥é˜Ÿåˆ—
  // å¹¶å‘å‡ºé€šçŸ¥
  std::lock_guard&lt;std::mutex&gt; lk(mut);
  data_queue.push(data);
  cond.notify_one();
  return SUCCESS_CODE;
}

// InputDataåœ¨ç”Ÿäº§è€…çº¿ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œå°†å¾…åˆ†ææ•°æ®é€å…¥é˜Ÿåˆ—
// æ¶ˆè´¹çº¿ç¨‹å‡½æ•°Processä»é˜Ÿåˆ—å–æ•°æ®ä»¥è¿›è¡Œåˆ†æ
// çº¿ç¨‹åœ¨æ¡ä»¶æœªå‘ç”Ÿæ—¶å› waitå‡½æ•°é˜»å¡è¿›å…¥ç¡çœ çŠ¶æ€
void Process()
{
  while (not_exit_expression)
  {
    // ä½¿ç”¨unique_lockè€Œélock_guard
    std::unique_lock&lt;std::mutex&gt; lk(mut);

    // waitå‡½æ•°åœ¨æ¡ä»¶æ»¡è¶³æ—¶è¿”å›ï¼Œå¦åˆ™çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€
    //
    // è‹¥lambdaè¡¨è¾¾å¼è¿”å›falseï¼ˆå³ä¸æ¡ä»¶æ»¡è¶³ï¼‰ï¼Œåˆ™waité‡Šæ”¾lkä¸­é”èµ„æºï¼Œ
    // ä¸”çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä»¥ä¾¿ç”Ÿçº¿ç¨‹å¯ä»¥ç»§ç»­è·å–é”å¹¶é€æ•°æ®åˆ°é˜Ÿé‡Œï¼›å¦åˆ™ï¼Œ
    //
    // å½“notify_oneé€šçŸ¥æ¡ä»¶å˜é‡æ—¶ï¼Œæ¶ˆè´¹æ¶ˆé™¤ä»ç¡çœ çŠ¶æ€è‹é†’ï¼Œé‡æ–°è·å–é”ï¼Œä¸”å¯¹æ¡ä»¶å†æ¬¡æ£€æŸ¥ï¼Œlambdaè¡¨è¾¾å¼è¿”å›true
    // æ­¤æ—¶ï¼Œwaitè¿”å›å¹¶ç»§ç»­æŒæœ‰é”èµ„æºï¼Œç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œ
    cond.wait(lk, [](){ return !data_queue.empty(); });

    data_chunk data = data_queue.front();
    data_queue.pop();

    // waitè¿”å›åæŒæœ‰é”ï¼Œå› æ­¤éœ€è¦åœ¨æ­¤å¤„è§£é”
    lk.unlock();

    // å¤„ç†æ•°æ®
    process_the_data;
  }
}</code></code></pre>
<blockquote>
<p>ğŸ™‹ è‹¥å°†Processå¾ªç¯ä¸­é˜»å¡é€»è¾‘(waitå‡½æ•°)æ¢ä¸ºéé˜»å¡æ¨¡å¼é€»è¾‘â€”â€”å³å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¾ªç¯continueï¼Œå°†å¦‚ä½•å½±å“Processçº¿ç¨‹ï¼Ÿ</p>
</blockquote>
<p>ä»¥ä¸Šä»£ç ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä½¿ç”¨std::unique_lockè€Œéstd::lock_guardæ˜¯å› ä¸ºå‰è€…è¾ƒåè€…çµæ´»ï¼Œstd::lock_guardæœªå®ç°lock/unlockæˆå‘˜å‡½æ•°ã€‚å¦å¤–ï¼Œé˜Ÿåˆ—åœ¨çº¿ç¨‹é—´ä¼ é€’æ•°æ®åº”ç”¨å¹¿æ³›ï¼Œå°†éçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—å’Œæ¡ä»¶å˜é‡å°è£…åˆ°å…·ä½“åœºæ™¯ç±»ï¼Œä¸ä»…ç¼–ç é‡å¤ï¼Œè€Œä¸”ä½æ•ˆæ˜“å‡ºé”™ã€‚å› æ­¤ï¼Œå®ç°çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æ˜¯ååˆ†å¿…è¦çš„ã€‚</p>
<h2 id="çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—é€‚é…å™¨">çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—é€‚é…å™¨</h2>
<p>ä¸Šå°èŠ‚å·²ä»‹ç»äº†â€œé˜Ÿåˆ—ï¼Œæ¡ä»¶å˜é‡å’Œäº’æ–¥é‡â€çš„åº”ç”¨åœºæ™¯ï¼Œç°å°†å®ƒä»¬å°è£…ä¸ºçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—é€‚é…å™¨â€”â€”CTSQueueã€‚</p>
<p>çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ— - éœ€æ±‚åˆ†æï¼š</p>
<ul>
<li>ä»å…·å¤‡é˜Ÿåˆ—çš„å…ˆå…¥å…ˆå‡ºç‰¹æ€§ï¼›</li>
<li>æ”¯æŒæ•°æ®é˜Ÿå°¾å…¥é˜Ÿåˆ—ã€é˜Ÿé¦–å‡ºé˜Ÿåˆ—æ“ä½œï¼›</li>
<li>æä¾›é˜»å¡å’Œéé˜»å¡ç‰ˆæœ¬å‡ºé˜Ÿåˆ—æ“ä½œï¼›</li>
<li>æ³›å‹é˜Ÿåˆ—ï¼›</li>
<li>ä½¿ç”¨C++11å®¹å™¨åŠçº¿ç¨‹åŒæ­¥åŸè¯­ï¼Œå½“ç„¶ä¹Ÿå¯ä½¿ç”¨å…¶ä»–å¦‚posixæä¾›çš„åŒæ­¥åŸè¯­ï¼›</li>
</ul>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code><code>#include &lt;queue&gt;              // for queue
#include &lt;memory&gt;             // for std::shared_ptr
#include &lt;mutex&gt;              // for std::mutex
#include &lt;condition_variable&gt; // for std::condition_variable

// çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—
template&lt;typename T&gt;
class CTSQueue
{
public:
  CTSQueue() = default;
  ~CTSQueue()
  { }

  // ä¸æä¾›å¤åˆ¶æ“ä½œ - ç¦ç”¨
  CTSQueue(const CTSQueue&amp;) = delete;
  CTSQueue&amp; operator=(const CTSQueue&amp;) = delete;

  // å…¥é˜Ÿåˆ—æ“ä½œ
  void Push(T data)
  {
    std::lock_guard&lt;std::mutex&gt; lk(mut_);
    data_queue_.push(data);
    cond_.notify_one();
  }

  // å‡ºé˜Ÿåˆ—æ“ä½œ - éé˜»å¡ç‰ˆæœ¬
  bool TryPop(T&amp; data)
  {
    std::lock_guard&lt;std::mutex&gt; lk(mut_);
    // ç©ºé˜Ÿåˆ—ç«‹é©¬è¿”å›å‡ºé˜Ÿåˆ—å¤±è´¥ï¼Œå¦åˆ™
    // æ•°æ®å‡ºé˜Ÿåˆ—ï¼ˆæ‹·è´ç‰ˆæœ¬ï¼‰
    if (data_queue_.empty())
    {
      return false;
    }
    data = data_queue_.front();
    data_queue_.pop();
    return true;
  }
  std::shared_ptr&lt;T&gt; TryPop()
  {
    std::lock_guard&lt;std::mutex&gt; lk(mut_);
    if (data_queue_.empty())
    {
      return std::shared_ptr&lt;T&gt;();
    }
    // å‡ºé˜Ÿåˆ—ï¼ˆéæ‹·è´ç‰ˆæœ¬ï¼‰
    std::shared_ptr&lt;T&gt; res(std::make_shared&lt;T&gt;(data_queue_.front()));
    data_queue_.pop();
    return res;
  }

  // å‡ºé˜Ÿåˆ—æ“ä½œ - é˜»å¡ç‰ˆæœ¬
  void WaitPop(T&amp; data)
  {
    std::lock_guard&lt;std::mutex&gt; lk(mut_);
    // æ¡ä»¶æœªå‘ç”Ÿæ—¶ï¼Œè°ƒç”¨çº¿ç¨‹é˜»å¡
    // å¦åˆ™ï¼Œæ•°æ®å‡ºé˜Ÿåˆ—ï¼ˆæ‹·è´ç‰ˆæœ¬ï¼‰
    cond_.wait(lk, [this](){ return !data_queue_.empty() });
    data = data_queue_.front();
    data_queue_.pop();
  }
  std::shared_ptr&lt;T&gt; WaitPop()
  {
    std::lock_guard&lt;std::mutex&gt; lk(mut_);
    cond_.wait(lk, [this](){ return !data_queue_.empty() });
    // å‡ºé˜Ÿåˆ—ï¼ˆéæ‹·è´ç‰ˆæœ¬ï¼‰
    std::shared_ptr&lt;T&gt; res(std::make_shared&lt;T&gt;(data_queue_.front()));
    data_queue_.pop();
    return res;
  }

  // æŸ¥è¯¢é˜Ÿåˆ—çŠ¶æ€æ“ä½œ
  bool Empty() const
  {
    std::lock_guard&lt;std::mutex&gt; lk(mut_);
    return data_queue_.empty();
  }

private:
  mutable std::mutex      mut_;
  std::queue&lt;T&gt;           data_queue_;
  std::condition_variable cond_;
};</code></code></pre>
<p>å‚è€ƒæ–‡çŒ®ï¼š<br />
[1] ã€ŠC++ Concurrency In Actionã€‹, <a href="https://www.bogotobogo.com/cplusplus/files/CplusplusConcurrencyInAction_PracticalMultithreading.pdf" class="uri">https://www.bogotobogo.com/cplusplus/files/CplusplusConcurrencyInAction_PracticalMultithreading.pdf</a></p>

</div></div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>