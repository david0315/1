<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修系统集成Facebook授权发布帖子以及获取帖子评论等功能' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>系统集成Facebook授权发布帖子以及获取帖子评论等功能</center></div><div class='banquan'>原文出处:本文由博客园博主不曾流泪的鱼提供。<br/>
原文连接:https://www.cnblogs.com/tonyjude/p/11451742.html</div><br>
    <h3><span style="font-size: 1.17em;">公司的业务和海外贸易紧密连接，项目中需要对接Facebook、Google、Twitter相关API，下面详细描述一下我们对接Facebook中遇到的问题</span></h3>
<h4>1，注册Facebook账户，Facebook账户注册还是比较麻烦的，有IP限制，一个IP不能注册多个账户，很容易被封。注册完之后会有身份审核过程，这个过程尽量用真实身份，审核成功后就可以申请成为Facebook开发者了。</h4>
<h3>2，成为Facebook开发者之后，创建应用，获取应用编号和应用密钥，完善邮箱等官方需要提供的信息</h3>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能0.jpg" alt="" width="1019" height="325" /></p>
<h3><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能1.jpg" alt="" width="1018" height="427" /></h3>
<h3>3，完成公司验证，签署合同条款</h3>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能2.jpg" alt="" /></p>
<h3>4，创建测试帐号，项目需求需要的可以多创建几个测试帐号，互相加为好友</h3>
<p>测试帐号可以在本地开发中使用，没有任何权限限制，所有的功能模块都可以通过测试帐号实现，在功能开发完成后，部署到一台线上的测试环境进行Facebook的审核，线上域名必须添加SSL加密</p>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能3.jpg" alt="" width="1008" height="397" /></p>
<h3>5，添加Fackbook登录，Facebook登录API提供了SDK和图谱两种方式进行登录，在实际的开发中两者需要结合进行开发，我们是用下载的PHP版本的SDk，&nbsp;使用&nbsp;Composer来获取依赖包，建议不要使用Git去拉取代码，可能有些依赖包需要手动去安装，避免出现目明其妙的报错，下面是官方提供的SDK</h3>
<p><a href="https://developers.facebook.com/docs/reference/php">https://developers.facebook.com/docs/reference/php</a></p>
<p>&nbsp;</p>
<h3>6，添加Fackbook登录需要创建应用程序</h3>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能4.jpg" alt="" width="1008" height="396" /></p>
<h4>这里添加有效跳转URI，这里的跳转链接是在功能完善后，部署到线上环境提交给facebook审核需要的，本地测试不需要，例如本地locahost:8080是无法添加跳转URI的</h4>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能5.jpg" alt="" width="1006" height="464" /></p>
<h4>Facebook官方要求提供退出登录取消授权入口，至于这里的数据删除请求网址，笔者发现不是必须的，所以提供退出入口即可，以免审核不通过</h4>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能6.jpg" alt="" width="1010" height="385" /></p>
<h3>7，Facebook 权限列表</h3>
<p><a href="https://developers.facebook.com/docs/facebook-login/permissions/">https://developers.facebook.com/docs/facebook-login/permissions/</a></p>
<h3>依据项目需求进行合理的申请，用不到的权限不要申请，如果项目需要用到的权限比较多，尽量一次申请不超过2个权限</h3>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能7.jpg" alt="" width="996" height="539" /></p>
<h3>申请的步骤：</h3>
<h3>1，添加申请理由， 就是描述一下项目如果使用这个权限和为用户带来哪些作用，尽量用英文描述，因为审核的平台是美国Facebook的客服，是看不懂中文的！</h3>
<h3>2，录屏，这里需要用到录屏软件，官方有推荐&nbsp;<a href="https://www.apowersoft.cn/free-online-screen-recorder">https://www.apowersoft.cn/free-online-screen-recorder</a>&nbsp;很好用的一款录屏软件</h3>
<h3>3，提交申请，Facebook的审核时间还是很及时的，一般不超过3天，两个工作日差不多就给回复了，只不过给到的回复太过于官方了，不够详细，需要多花点时间琢磨！</h3>
<p>这里是我们申请成功的权限，新手第一次对接，感觉太南了，太南了。。。</p>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能8.jpg" alt="" width="1076" height="492" /></p>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能9.jpg" alt="" width="1093" height="361" /></p>
<p><img src="./images/系统集成Facebook授权发布帖子以及获取帖子评论等功能10.jpg" alt="" width="1093" height="510" /></p>
<h3>8，这里总结一下，顺便吐槽一下Facebook的API, 没有Google写的详细，有些功能没有，API也没声明，遇到很多坑，折腾了好久，最好打听到是因为隐私政策不予给出，MMP。。。</h3>
<h3>最后提一下这里用到的 OAuth授权流程，没有接触过的同学先去了解一下，我这里大概说一下。</h3>
<h3>通过之前创建的应该，可以获取应用编号和应用密钥，通过这两者获取到一个有效期为3个月的token， 每次请求Facebook API的时候必须带着这个token去获取一个临时token，然后通过这个临时token再进行请求最后的接口数据</h3>
<h3>&nbsp;这里我贴一下php相关代码</h3>
<p>授权登录和获取临时访问口令：</p>
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1　　　　　 </span><span style="color: #800080;">$appId</span> = facebook appId<span style="color: #000000;">;
</span><span style="color: #008080;"> 2</span>         <span style="color: #800080;">$appSecret</span> = facebook appSecret<span style="color: #000000;">;
</span><span style="color: #008080;"> 3</span>         <span style="color: #800080;">$callbackUrl</span> = facebook callbackUrl<span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span>         <span style="color: #800080;">$fb</span> = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Facebook\Facebook([
</span><span style="color: #008080;"> 5</span>             'app_id' =&gt; <span style="color: #800080;">$appId</span>,
<span style="color: #008080;"> 6</span>             'app_secret' =&gt; <span style="color: #800080;">$appSecret</span>,
<span style="color: #008080;"> 7</span>             'default_graph_version' =&gt; 'v2.10',
<span style="color: #008080;"> 8</span> <span style="color: #000000;">        ]);
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>         <span style="color: #800080;">$helper</span> = <span style="color: #800080;">$fb</span>-&gt;<span style="color: #000000;">getRedirectLoginHelper();
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">12</span>             <span style="color: #800080;">$accessToken</span> = <span style="color: #800080;">$helper</span>-&gt;<span style="color: #000000;">getAccessToken();
</span><span style="color: #008080;">13</span>         } <span style="color: #0000ff;">catch</span>(Facebook\Exceptions\FacebookResponseException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
</span><span style="color: #008080;">14</span>             <span style="color: #0000ff;">echo</span> 'Graph returned an error: ' . <span style="color: #800080;">$e</span>-&gt;<span style="color: #000000;">getMessage();
</span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">exit</span><span style="color: #000000;">;
</span><span style="color: #008080;">16</span>         } <span style="color: #0000ff;">catch</span>(Facebook\Exceptions\FacebookSDKException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
</span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">echo</span> 'Facebook SDK returned an error: ' . <span style="color: #800080;">$e</span>-&gt;<span style="color: #000000;">getMessage();
</span><span style="color: #008080;">18</span>             <span style="color: #0000ff;">exit</span><span style="color: #000000;">;
</span><span style="color: #008080;">19</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>         <span style="color: #0000ff;">if</span> (! <span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$accessToken</span><span style="color: #000000;">)) {
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">if</span> (<span style="color: #800080;">$helper</span>-&gt;<span style="color: #000000;">getError()) {
</span><span style="color: #008080;">23</span>                 <span style="color: #008080;">header</span>('HTTP/1.0 401 Unauthorized'<span style="color: #000000;">);
</span><span style="color: #008080;">24</span>                 <span style="color: #0000ff;">echo</span> '请检查账号设置，Facebook账号无法获得授权，详情：' . <span style="color: #800080;">$helper</span>-&gt;getError()   . ' ' . <span style="color: #800080;">$helper</span>-&gt;getErrorCode() . ' ' . <span style="color: #800080;">$helper</span>-&gt;getErrorReason()  . ' ' . <span style="color: #800080;">$helper</span>-&gt;getErrorDescription() . "\n"<span style="color: #000000;">;
</span><span style="color: #008080;">25</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">26</span>                 <span style="color: #008080;">header</span>('HTTP/1.0 400 Bad Request'<span style="color: #000000;">);
</span><span style="color: #008080;">27</span>                 <span style="color: #0000ff;">echo</span> 'Bad request'<span style="color: #000000;">;
</span><span style="color: #008080;">28</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">29</span>             <span style="color: #0000ff;">exit</span><span style="color: #000000;">;
</span><span style="color: #008080;">30</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">31</span> 
<span style="color: #008080;">32</span>         <span style="color: #800080;">$accessToken</span> = <span style="color: #800080;">$accessToken</span>-&gt;<span style="color: #000000;">getValue();
</span><span style="color: #008080;">33</span>         <span style="color: #800080;">$oAuth2Client</span> = <span style="color: #800080;">$fb</span>-&gt;<span style="color: #000000;">getOAuth2Client();
</span><span style="color: #008080;">34</span>         <span style="color: #800080;">$tokenMetadata</span> = <span style="color: #800080;">$oAuth2Client</span>-&gt;debugToken(<span style="color: #800080;">$accessToken</span><span style="color: #000000;">);
</span><span style="color: #008080;">35</span>         <span style="color: #800080;">$tokenMetadata</span>-&gt;validateAppId(<span style="color: #800080;">$appId</span><span style="color: #000000;">);
</span><span style="color: #008080;">36</span>         <span style="color: #800080;">$tokenMetadata</span>-&gt;<span style="color: #000000;">validateExpiration();
</span><span style="color: #008080;">37</span> 
<span style="color: #008080;">38</span>         <span style="color: #800080;">$appId</span> = <span style="color: #800080;">$tokenMetadata</span>-&gt;getField('app_id'<span style="color: #000000;">);
</span><span style="color: #008080;">39</span>         <span style="color: #800080;">$type</span> = <span style="color: #800080;">$tokenMetadata</span>-&gt;getField('type'<span style="color: #000000;">);
</span><span style="color: #008080;">40</span>         <span style="color: #800080;">$userId</span> = <span style="color: #800080;">$tokenMetadata</span>-&gt;getField('user_id'<span style="color: #000000;">);
</span><span style="color: #008080;">41</span>         <span style="color: #800080;">$application</span> = <span style="color: #800080;">$tokenMetadata</span>-&gt;getField('application'<span style="color: #000000;">);
</span><span style="color: #008080;">42</span>         <span style="color: #800080;">$isValid</span> = <span style="color: #800080;">$tokenMetadata</span>-&gt;getField('is_valid'<span style="color: #000000;">);
</span><span style="color: #008080;">43</span>         <span style="color: #800080;">$expiresAt</span> = <span style="color: #800080;">$tokenMetadata</span>-&gt;getField('data_access_expires_at'<span style="color: #000000;">);
</span><span style="color: #008080;">44</span>         <span style="color: #800080;">$metadata</span> =<span style="color: #000000;"> [
</span><span style="color: #008080;">45</span>             "app_id" =&gt; <span style="color: #800080;">$appId</span>,
<span style="color: #008080;">46</span>             "type"=&gt; <span style="color: #800080;">$type</span>,
<span style="color: #008080;">47</span>             "user_id" =&gt; <span style="color: #800080;">$userId</span>,
<span style="color: #008080;">48</span>             "application" =&gt; <span style="color: #800080;">$application</span>,
<span style="color: #008080;">49</span>             "expires_at" =&gt; <span style="color: #800080;">$expiresAt</span>,
<span style="color: #008080;">50</span>             "is_valid" =&gt; <span style="color: #800080;">$isValid</span>
<span style="color: #008080;">51</span> <span style="color: #000000;">        ];
</span><span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span>         <span style="color: #800080;">$auth</span> = <span style="color: #0000ff;">new</span> Facebook\Authentication\AccessToken(<span style="color: #800080;">$accessToken</span><span style="color: #000000;">);
</span><span style="color: #008080;">54</span>         <span style="color: #0000ff;">if</span> (! <span style="color: #800080;">$auth</span>-&gt;<span style="color: #000000;">isLongLived()) {
</span><span style="color: #008080;">55</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">56</span>                 <span style="color: #800080;">$accessToken</span> = <span style="color: #800080;">$oAuth2Client</span>-&gt;getLongLivedAccessToken(<span style="color: #800080;">$accessToken</span><span style="color: #000000;">);
</span><span style="color: #008080;">57</span>             } <span style="color: #0000ff;">catch</span> (Facebook\Exceptions\FacebookSDKException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
</span><span style="color: #008080;">58</span>                 <span style="color: #0000ff;">echo</span> "&lt;p&gt;Error getting long-lived access token: " . <span style="color: #800080;">$e</span>-&gt;getMessage() . "&lt;/p&gt;\n\n"<span style="color: #000000;">;
</span><span style="color: #008080;">59</span>                 <span style="color: #0000ff;">exit</span><span style="color: #000000;">;
</span><span style="color: #008080;">60</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">61</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">62</span> 
<span style="color: #008080;">63</span>     　　　　
<span style="color: #008080;">65</span>         <span style="color: #800080;">$this</span>-&gt;cache-&gt;set(<span style="color: #800080;">$this</span>-&gt;facebookAccessTokenKey,(<span style="color: #0000ff;">string</span>) <span style="color: #800080;">$accessToken</span><span style="color: #000000;"> );
</span><span style="color: #008080;">66</span>         <span style="color: #800080;">$this</span>-&gt;cache-&gt;set(<span style="color: #800080;">$this</span>-&gt;facebookKey, json_encode(<span style="color: #800080;">$metadata</span><span style="color: #000000;">));
</span><span style="color: #008080;">67</span> 
<span style="color: #008080;">68</span>         <span style="color: #008080;">header</span>("Location: {<span style="color: #800080;">$callbackUrl</span>}");　　</code></pre>

<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> 　　<span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;"> 2</span> <span style="color: #008000;">     * 获取临时访问口令
</span><span style="color: #008080;"> 3</span> <span style="color: #008000;">     * @param $pageId
</span><span style="color: #008080;"> 4</span> <span style="color: #008000;">     * @param $access_token
</span><span style="color: #008080;"> 5</span> <span style="color: #008000;">     * @return mixed
</span><span style="color: #008080;"> 6</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> getPageAccessToken(<span style="color: #800080;">$pageId</span>, <span style="color: #800080;">$access_token</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 9</span>         <span style="color: #800080;">$accessTokenUrl</span> = "https://graph.facebook.com/v4.0/{<span style="color: #800080;">$pageId</span>}?fields=access_token&amp;access_token={<span style="color: #800080;">$access_token</span>}"<span style="color: #000000;">;
</span><span style="color: #008080;">10</span>         <span style="color: #800080;">$pageAccessTokenInfo</span> = curl(<span style="color: #800080;">$accessTokenUrl</span><span style="color: #000000;">);
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;">{
</span><span style="color: #008080;">12</span>             <span style="color: #800080;">$pageAccessTokenInfo</span> = json_decode(<span style="color: #800080;">$pageAccessTokenInfo</span>, <span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;">13</span>             <span style="color: #800080;">$pageAccessToken</span> = <span style="color: #800080;">$pageAccessTokenInfo</span>['access_token'<span style="color: #000000;">];
</span><span style="color: #008080;">14</span>         }<span style="color: #0000ff;">catch</span> (<span style="color: #0000ff;">Exception</span> <span style="color: #800080;">$e</span><span style="color: #000000;">) {
</span><span style="color: #008080;">15</span>             <span style="color: #800080;">$this</span>-&gt;showResults(-1, <span style="color: #0000ff;">null</span>, '获取page_access_token失败！'<span style="color: #000000;">);
</span><span style="color: #008080;">16</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$pageAccessToken</span><span style="color: #000000;">;
</span><span style="color: #008080;">19</span>     }</code></pre>

<h4><span style="background-color: #ffffff; color: #ff0000;">唤起授权对话框，我们的业务权限是&nbsp;<code><a href="https://developers.facebook.com/docs/facebook-login/permissions/#reference-manage_pages"><span style="background-color: #ffffff; color: #ff0000;">manage_pages</span></a>&nbsp;和&nbsp;<code><a href="https://developers.facebook.com/docs/facebook-login/permissions/#reference-publish_pages"><span style="background-color: #ffffff; color: #ff0000;">publish_pages</span></a>&nbsp;，权限不同的自行更改！</code></code></span></h4>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">　　 /*</span><span style="color: #008000;">*
     * 获取facebook授权code
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> bindAction(){
        </span><span style="color: #800080;">$redirectUrl</span> = facebook redirectUrl<span style="color: #000000;">;
        </span><span style="color: #800080;">$appId</span> = facebook appId<span style="color: #000000;">;
        </span><span style="color: #800080;">$appSecret</span> = facebook appSecret<span style="color: #000000;">;
        </span><span style="color: #800080;">$fb</span> = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Facebook\Facebook([
            </span>'app_id' =&gt; <span style="color: #800080;">$appId</span>,
            'app_secret' =&gt; <span style="color: #800080;">$appSecret</span>,
            'default_graph_version' =&gt; 'v2.10',<span style="color: #000000;">
        ]);
        </span><span style="color: #800080;">$helper</span> = <span style="color: #800080;">$fb</span>-&gt;<span style="color: #000000;">getRedirectLoginHelper();
        </span><span style="color: #800080;">$permissions</span> = ['manage_pages','publish_pages'<span style="color: #000000;">];
        </span><span style="color: #800080;">$codeUrl</span> = <span style="color: #800080;">$helper</span>-&gt;getLoginUrl(<span style="color: #800080;">$redirectUrl</span>, <span style="color: #800080;">$permissions</span><span style="color: #000000;">);
        </span><span style="color: #800080;">$this</span>-&gt;showResults(1, ['url' =&gt; <span style="color: #800080;">$codeUrl</span><span style="color: #000000;">]);
    }</span></code></pre>

<h3>完整的发帖代码</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">　　/*</span><span style="color: #008000;">*
     * facebook分享发布
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> facebookShareAction()
    {
        </span><span style="color: #800080;">$data</span> = getPost('data'<span style="color: #000000;">);</span><span style="color: #008000;">//</span><span style="color: #008000;">一次请求中只能有一个选项  1，分享链接， 2单张图片链接， 3，多张图片ID</span>
        <span style="color: #800080;">$content</span>['message'] = <span style="color: #800080;">$data</span>['message'<span style="color: #000000;">];
        </span><span style="color: #0000ff;">if</span> (<span style="color: #800080;">$data</span>['link'<span style="color: #000000;">]) {
            </span><span style="color: #800080;">$content</span>['link'] = <span style="color: #800080;">$data</span>['link'<span style="color: #000000;">];
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #800080;">$data</span>['url'<span style="color: #000000;">]) {
            </span><span style="color: #800080;">$content</span>['link'] = ''<span style="color: #000000;">;
            </span><span style="color: #800080;">$content</span>['url'] = <span style="color: #800080;">$data</span>['url'<span style="color: #000000;">];
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #800080;">$data</span>['attached_media'<span style="color: #000000;">]) {
            </span><span style="color: #800080;">$content</span>['link'] = ''<span style="color: #000000;">;
            </span><span style="color: #800080;">$content</span>['url'] = ''<span style="color: #000000;">;

            </span><span style="color: #800080;">$media</span> = <span style="color: #008080;">explode</span>(',', <span style="color: #800080;">$data</span>['attached_media'<span style="color: #000000;">]);
            </span><span style="color: #0000ff;">if</span> (<span style="color: #008080;">count</span>(<span style="color: #800080;">$media</span>) &gt;= 10<span style="color: #000000;">) {
                </span><span style="color: #800080;">$this</span>-&gt;showResults(-2, <span style="color: #0000ff;">null</span>, '一次上传最多不能超过9张图片！'<span style="color: #000000;">);
            }
            </span><span style="color: #0000ff;">foreach</span> (<span style="color: #800080;">$media</span> <span style="color: #0000ff;">as</span> <span style="color: #800080;">$mediaId</span><span style="color: #000000;">) {
                </span><span style="color: #800080;">$temp</span>[] = ['media_fbid' =&gt; <span style="color: #800080;">$mediaId</span><span style="color: #000000;">];
            }

            </span><span style="color: #800080;">$content</span>['attached_media'] = json_encode(<span style="color: #800080;">$temp</span><span style="color: #000000;">);
        }

        </span><span style="color: #800080;">$appId</span> = facebook appId<span style="color: #000000;">;
        </span><span style="color: #800080;">$appSecret</span> = facebook appSecret<span style="color: #000000;">;
        </span><span style="color: #800080;">$fbAccessToken</span> = <span style="color: #800080;">$this</span>-&gt;cache-&gt;get(<span style="color: #800080;">$this</span>-&gt;<span style="color: #000000;">facebookAccessTokenKey);
        </span><span style="color: #0000ff;">if</span> (!<span style="color: #800080;">$fbAccessToken</span><span style="color: #000000;">) {
            </span><span style="color: #800080;">$this</span>-&gt;showResults(-1, <span style="color: #0000ff;">null</span>, '请先绑定Facebook账号！'<span style="color: #000000;">);
        }

        </span><span style="color: #800080;">$fb</span> = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Facebook\Facebook([
            </span>'app_id' =&gt; <span style="color: #800080;">$appId</span>,
            'app_secret' =&gt; <span style="color: #800080;">$appSecret</span>,
            'default_graph_version' =&gt; 'v2.3',<span style="color: #000000;">
        ]);

        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            </span><span style="color: #800080;">$response</span> = <span style="color: #800080;">$fb</span>-&gt;<span style="color: #000000;">get(
                </span>'/me/accounts',
                <span style="color: #800080;">$fbAccessToken</span><span style="color: #000000;">
            );
        } </span><span style="color: #0000ff;">catch</span>(FacebookExceptionsFacebookResponseException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">echo</span> 'Graph returned an error: ' . <span style="color: #800080;">$e</span>-&gt;<span style="color: #000000;">getMessage();
            </span><span style="color: #0000ff;">exit</span><span style="color: #000000;">;
        } </span><span style="color: #0000ff;">catch</span>(FacebookExceptionsFacebookSDKException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">echo</span> 'Facebook SDK returned an error: ' . <span style="color: #800080;">$e</span>-&gt;<span style="color: #000000;">getMessage();
            </span><span style="color: #0000ff;">exit</span><span style="color: #000000;">;
        }

        </span><span style="color: #800080;">$accountInfo</span> = <span style="color: #800080;">$response</span>-&gt;<span style="color: #000000;">getBody();
        </span><span style="color: #800080;">$accountInfo</span> = json_decode(<span style="color: #800080;">$accountInfo</span>, <span style="color: #0000ff;">true</span><span style="color: #000000;">);
        </span><span style="color: #800080;">$pageId</span> =  <span style="color: #800080;">$accountInfo</span>['data'][0]['id'<span style="color: #000000;">];
        </span><span style="color: #800080;">$accessToken</span> =  <span style="color: #800080;">$accountInfo</span>['data'][0]['access_token'<span style="color: #000000;">];
        </span><span style="color: #800080;">$pageAccessToken</span> = <span style="color: #800080;">$this</span>-&gt;getPageAccessToken(<span style="color: #800080;">$pageId</span>, <span style="color: #800080;">$accessToken</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            </span><span style="color: #800080;">$response</span> = <span style="color: #800080;">$fb</span>-&gt;<span style="color: #000000;">post(
                </span>'/' . <span style="color: #800080;">$pageId</span> . '/feed',
                <span style="color: #800080;">$content</span>,
                <span style="color: #800080;">$pageAccessToken</span><span style="color: #000000;">
            );
        } </span><span style="color: #0000ff;">catch</span>(FacebookExceptionsFacebookResponseException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">echo</span> 'Graph returned an error: ' . <span style="color: #800080;">$e</span>-&gt;<span style="color: #000000;">getMessage();
            </span><span style="color: #0000ff;">exit</span><span style="color: #000000;">;
        } </span><span style="color: #0000ff;">catch</span>(FacebookExceptionsFacebookSDKException <span style="color: #800080;">$e</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">echo</span> 'Facebook SDK returned an error: ' . <span style="color: #800080;">$e</span>-&gt;<span style="color: #000000;">getMessage();
            </span><span style="color: #0000ff;">exit</span><span style="color: #000000;">;
        }

        </span><span style="color: #800080;">$info</span> = <span style="color: #800080;">$response</span>-&gt;<span style="color: #000000;">getBody();
        </span><span style="color: #800080;">$info</span> = json_decode(<span style="color: #800080;">$info</span>, <span style="color: #0000ff;">true</span><span style="color: #000000;">);
        </span><span style="color: #800080;">$this</span>-&gt;showResults(1, ['data' =&gt; ['id' =&gt; <span style="color: #800080;">$info</span>['id'<span style="color: #000000;">]]]);
    }</span></code></pre>

<p>&nbsp;</p>
<h2>最后祝大家对接API成功！</h2>
<p>&nbsp;</p>

</div></div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>