<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修PHP+Redis实现延迟任务，实现自动取消与完成订单' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>PHP+Redis实现延迟任务，实现自动取消与完成订单</center></div><div class='banquan'>原文出处:本文由博客园博主程序媛的明天提供。<br/>
原文连接:https://www.cnblogs.com/a609251438/p/11970700.html</div><br>
    <p>简单定时任务解决方案：使用redis的keyspace notifications（键失效后通知事件） ；</p>
<p><strong>(A)业务场景：</strong></p>
<p>1、当一个业务触发以后需要启动一个定时任务，在指定时间内再去执行一个任务（如自动取消订单，自动完成订单等功能）</p>
<p>2、redis的keyspace notifications 会在key失效后发送一个事件，监听此事件的的客户端就可以收到通知</p>
<p><strong>(B)服务准备：</strong></p>
<p>1、修改reids配置文件（redis.conf）【window系统配置文件为：redis.windows.conf 】</p>
<p>redis默认不会开启keyspace notifications，因为开启后会对cpu有消耗</p>
<p>备注： E：keyevent事件，事件以__keyevent@&lt;db&gt;__为前缀进行发布；</p>
<p>x：过期事件，当某个键过期并删除时会产生该事件；</p>
<p>原配置为：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>notify-keyspace-events <span style="color: #800000;">""</span></code></pre>


<p>更改 配置如下：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>notify-keyspace-events <span style="color: #800000;">"</span><span style="color: #800000;">Ex</span><span style="color: #800000;">"</span></code></pre>


<p>保存配置后，重启Redis服务，使配置生效</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;">1</span> <span style="color: #000000;">[root@chokingwin etc]#
</span><span style="color: #008080;">2</span> service redis-server restart /usr/local/redis/etc/<span style="color: #000000;">redis.conf 
</span><span style="color: #008080;">3</span> Stopping redis-<span style="color: #000000;">server: [ OK ] 
</span><span style="color: #008080;">4</span> Starting redis-server: [ OK ]</code></pre>

<p>&nbsp;</p>

<p>window系统重启redis ，先切换到redis文件目录，然后关闭redis服务（redis-server --service-stop），再开启（redis-server --service-start）</p>
<p><img src="./images/PHP+Redis实现延迟任务，实现自动取消与完成订单0.jpg" alt="" /></p>
<src>
<p><strong>(C)文件代码：</strong></p>
<p>phpredis实现订阅Keyspace notification,可实现自动取消订单，自动完成订单。以下为测试例子</p>
<p>创建4个文件，然后自行修改数据库和redis配置参数</p>
<p>db.class.php</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;">  1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> mysql
</span><span style="color: #008080;">  3</span> <span style="color: #000000;">{
</span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> $mysqli;
</span><span style="color: #008080;">  5</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> $result;
</span><span style="color: #008080;">  6</span>     <span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;">  7</span> <span style="color: #008000;">     * 数据库连接
</span><span style="color: #008080;">  8</span> <span style="color: #008000;">     * @param $config 配置数组
</span><span style="color: #008080;">  9</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 10</span> 
<span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> function connect()
</span><span style="color: #008080;"> 12</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 13</span>         $config=<span style="color: #000000;">array(
</span><span style="color: #008080;"> 14</span>             <span style="color: #800000;">'</span><span style="color: #800000;">host</span><span style="color: #800000;">'</span>=&gt;<span style="color: #800000;">'</span><span style="color: #800000;">127.0.0.1</span><span style="color: #800000;">'</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 15</span>             <span style="color: #800000;">'</span><span style="color: #800000;">username</span><span style="color: #800000;">'</span>=&gt;<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 16</span>             <span style="color: #800000;">'</span><span style="color: #800000;">password</span><span style="color: #800000;">'</span>=&gt;<span style="color: #800000;">'</span><span style="color: #800000;">168168</span><span style="color: #800000;">'</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 17</span>             <span style="color: #800000;">'</span><span style="color: #800000;">database</span><span style="color: #800000;">'</span>=&gt;<span style="color: #800000;">'</span><span style="color: #800000;">test</span><span style="color: #800000;">'</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 18</span>             <span style="color: #800000;">'</span><span style="color: #800000;">port</span><span style="color: #800000;">'</span>=&gt;<span style="color: #800080;">3306</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 19</span> <span style="color: #000000;">        );
</span><span style="color: #008080;"> 20</span> 
<span style="color: #008080;"> 21</span>         $host = $config[<span style="color: #800000;">'</span><span style="color: #800000;">host</span><span style="color: #800000;">'</span>];    <span style="color: #008000;">//</span><span style="color: #008000;">主机地址</span>
<span style="color: #008080;"> 22</span>         $username = $config[<span style="color: #800000;">'</span><span style="color: #800000;">username</span><span style="color: #800000;">'</span>];<span style="color: #008000;">//</span><span style="color: #008000;">用户名</span>
<span style="color: #008080;"> 23</span>         $password = $config[<span style="color: #800000;">'</span><span style="color: #800000;">password</span><span style="color: #800000;">'</span>];<span style="color: #008000;">//</span><span style="color: #008000;">密码</span>
<span style="color: #008080;"> 24</span>         $database = $config[<span style="color: #800000;">'</span><span style="color: #800000;">database</span><span style="color: #800000;">'</span>];<span style="color: #008000;">//</span><span style="color: #008000;">数据库</span>
<span style="color: #008080;"> 25</span>         $port = $config[<span style="color: #800000;">'</span><span style="color: #800000;">port</span><span style="color: #800000;">'</span>];    <span style="color: #008000;">//</span><span style="color: #008000;">端口号</span>
<span style="color: #008080;"> 26</span>         $<span style="color: #0000ff;">this</span>-&gt;mysqli = <span style="color: #0000ff;">new</span><span style="color: #000000;"> mysqli($host, $username, $password, $database, $port);
</span><span style="color: #008080;"> 27</span> 
<span style="color: #008080;"> 28</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 29</span>     <span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;"> 30</span> <span style="color: #008000;">     * 数据查询
</span><span style="color: #008080;"> 31</span> <span style="color: #008000;">     * @param $table 数据表
</span><span style="color: #008080;"> 32</span> <span style="color: #008000;">     * @param null $field 字段
</span><span style="color: #008080;"> 33</span> <span style="color: #008000;">     * @param null $where 条件
</span><span style="color: #008080;"> 34</span> <span style="color: #008000;">     * @return mixed 查询结果数目
</span><span style="color: #008080;"> 35</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">public</span> function <span style="color: #0000ff;">select</span>($table, $field = <span style="color: #0000ff;">null</span>, $<span style="color: #0000ff;">where</span> = <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 37</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 38</span>         $sql = <span style="color: #800000;">"</span><span style="color: #800000;">SELECT * FROM `{$table}`</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 39</span>         <span style="color: #008000;">//</span><span style="color: #008000;">echo $sql;exit;</span>
<span style="color: #008080;"> 40</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">empty($field)) {
</span><span style="color: #008080;"> 41</span>             $field = <span style="color: #800000;">'</span><span style="color: #800000;">`</span><span style="color: #800000;">'</span> . implode(<span style="color: #800000;">'</span><span style="color: #800000;">`,`</span><span style="color: #800000;">'</span>, $field) . <span style="color: #800000;">'</span><span style="color: #800000;">`</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 42</span>             $sql = str_replace(<span style="color: #800000;">'</span><span style="color: #800000;">*</span><span style="color: #800000;">'</span><span style="color: #000000;">, $field, $sql);
</span><span style="color: #008080;"> 43</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">if</span> (!empty($<span style="color: #0000ff;">where</span><span style="color: #000000;">)) {
</span><span style="color: #008080;"> 45</span>             $sql = $sql . <span style="color: #800000;">'</span><span style="color: #800000;"> WHERE </span><span style="color: #800000;">'</span> . $<span style="color: #0000ff;">where</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 46</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 47</span> 
<span style="color: #008080;"> 48</span> 
<span style="color: #008080;"> 49</span>         $<span style="color: #0000ff;">this</span>-&gt;result = $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">query($sql);
</span><span style="color: #008080;"> 50</span> 
<span style="color: #008080;"> 51</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;<span style="color: #000000;">result;
</span><span style="color: #008080;"> 52</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 53</span>     <span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;"> 54</span> <span style="color: #008000;">     * @return mixed 获取全部结果
</span><span style="color: #008080;"> 55</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 56</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> function fetchAll()
</span><span style="color: #008080;"> 57</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;result-&gt;<span style="color: #000000;">fetch_all(MYSQLI_ASSOC);
</span><span style="color: #008080;"> 59</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 60</span>     <span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;"> 61</span> <span style="color: #008000;">     * 插入数据
</span><span style="color: #008080;"> 62</span> <span style="color: #008000;">     * @param $table 数据表
</span><span style="color: #008080;"> 63</span> <span style="color: #008000;">     * @param $data 数据数组
</span><span style="color: #008080;"> 64</span> <span style="color: #008000;">     * @return mixed 插入ID
</span><span style="color: #008080;"> 65</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 66</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> function insert($table, $data)
</span><span style="color: #008080;"> 67</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">foreach</span> ($data <span style="color: #0000ff;">as</span> $key =&gt;<span style="color: #000000;"> $value) {
</span><span style="color: #008080;"> 69</span>             $data[$key] = $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">real_escape_string($value);
</span><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 71</span>         $keys = <span style="color: #800000;">'</span><span style="color: #800000;">`</span><span style="color: #800000;">'</span> . implode(<span style="color: #800000;">'</span><span style="color: #800000;">`,`</span><span style="color: #800000;">'</span>, array_keys($data)) . <span style="color: #800000;">'</span><span style="color: #800000;">`</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 72</span>         $values = <span style="color: #800000;">'</span><span style="color: #800000;">\'</span><span style="color: #800000;">'</span> . implode(<span style="color: #800000;">"</span><span style="color: #800000;">','</span><span style="color: #800000;">"</span>, array_values($data)) . <span style="color: #800000;">'</span><span style="color: #800000;">\'</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 73</span>         $sql = <span style="color: #800000;">"</span><span style="color: #800000;">INSERT INTO `{$table}`( {$keys} )VALUES( {$values} )</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 74</span>         $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">query($sql);
</span><span style="color: #008080;"> 75</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">insert_id;
</span><span style="color: #008080;"> 76</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 77</span>     <span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;"> 78</span> <span style="color: #008000;">     * 更新数据
</span><span style="color: #008080;"> 79</span> <span style="color: #008000;">     * @param $table 数据表
</span><span style="color: #008080;"> 80</span> <span style="color: #008000;">     * @param $data 数据数组
</span><span style="color: #008080;"> 81</span> <span style="color: #008000;">     * @param $where 过滤条件
</span><span style="color: #008080;"> 82</span> <span style="color: #008000;">     * @return mixed 受影响记录
</span><span style="color: #008080;"> 83</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 84</span>     <span style="color: #0000ff;">public</span> function update($table, $data, $<span style="color: #0000ff;">where</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 85</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 86</span>         <span style="color: #0000ff;">foreach</span> ($data <span style="color: #0000ff;">as</span> $key =&gt;<span style="color: #000000;"> $value) {
</span><span style="color: #008080;"> 87</span>             $data[$key] = $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">real_escape_string($value);
</span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 89</span>         $sets =<span style="color: #000000;"> array();
</span><span style="color: #008080;"> 90</span>         <span style="color: #0000ff;">foreach</span> ($data <span style="color: #0000ff;">as</span> $key =&gt;<span style="color: #000000;"> $value) {
</span><span style="color: #008080;"> 91</span>             $kstr = <span style="color: #800000;">'</span><span style="color: #800000;">`</span><span style="color: #800000;">'</span> . $key . <span style="color: #800000;">'</span><span style="color: #800000;">`</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 92</span>             $vstr = <span style="color: #800000;">'</span><span style="color: #800000;">\'</span><span style="color: #800000;">'</span> . $value . <span style="color: #800000;">'</span><span style="color: #800000;">\'</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 93</span>             array_push($sets, $kstr . <span style="color: #800000;">'</span><span style="color: #800000;">=</span><span style="color: #800000;">'</span><span style="color: #000000;"> . $vstr);
</span><span style="color: #008080;"> 94</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 95</span>         $kav = implode(<span style="color: #800000;">'</span><span style="color: #800000;">,</span><span style="color: #800000;">'</span><span style="color: #000000;">, $sets);
</span><span style="color: #008080;"> 96</span>         $sql = <span style="color: #800000;">"</span><span style="color: #800000;">UPDATE `{$table}` SET {$kav} WHERE {$where}</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 97</span> 
<span style="color: #008080;"> 98</span>         $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">query($sql);
</span><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">affected_rows;
</span><span style="color: #008080;">100</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">101</span>     <span style="color: #008000;">/*</span><span style="color: #008000;">*
</span><span style="color: #008080;">102</span> <span style="color: #008000;">     * 删除数据
</span><span style="color: #008080;">103</span> <span style="color: #008000;">     * @param $table 数据表
</span><span style="color: #008080;">104</span> <span style="color: #008000;">     * @param $where 过滤条件
</span><span style="color: #008080;">105</span> <span style="color: #008000;">     * @return mixed 受影响记录
</span><span style="color: #008080;">106</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">107</span>     <span style="color: #0000ff;">public</span> function delete($table, $<span style="color: #0000ff;">where</span><span style="color: #000000;">)
</span><span style="color: #008080;">108</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">109</span>         $sql = <span style="color: #800000;">"</span><span style="color: #800000;">DELETE FROM `{$table}` WHERE {$where}</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">110</span>         $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">query($sql);
</span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;mysqli-&gt;<span style="color: #000000;">affected_rows;
</span><span style="color: #008080;">112</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">113</span> }</code></pre>


<p>index.php</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> require_once <span style="color: #800000;">'</span><span style="color: #800000;">Redis2.class.php</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span> $redis = <span style="color: #0000ff;">new</span> \Redis2(<span style="color: #800000;">'</span><span style="color: #800000;">127.0.0.1</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">6379</span><span style="color: #800000;">'</span>,<span style="color: #800000;">''</span>,<span style="color: #800000;">'</span><span style="color: #800000;">15</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> $order_sn   = <span style="color: #800000;">'</span><span style="color: #800000;">SN</span><span style="color: #800000;">'</span>.time().<span style="color: #800000;">'</span><span style="color: #800000;">T</span><span style="color: #800000;">'</span>.rand(<span style="color: #800080;">10000000</span>,<span style="color: #800080;">99999999</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> $use_mysql = <span style="color: #800080;">1</span>;         <span style="color: #008000;">//</span><span style="color: #008000;">是否使用数据库，1使用，2不使用</span>
<span style="color: #008080;"> 9</span> <span style="color: #0000ff;">if</span>($use_mysql == <span style="color: #800080;">1</span><span style="color: #000000;">){
</span><span style="color: #008080;">10</span>    <span style="color: #008000;">/*</span>
<span style="color: #008080;">11</span> <span style="color: #008000;">    *   //数据表
</span><span style="color: #008080;">12</span> <span style="color: #008000;">    *   CREATE TABLE `order` (
</span><span style="color: #008080;">13</span> <span style="color: #008000;">    *      `ordersn` varchar(255) NOT NULL DEFAULT '',
</span><span style="color: #008080;">14</span> <span style="color: #008000;">    *      `status` varchar(255) NOT NULL DEFAULT '',
</span><span style="color: #008080;">15</span> <span style="color: #008000;">    *      `createtime` varchar(255) NOT NULL DEFAULT '',
</span><span style="color: #008080;">16</span> <span style="color: #008000;">    *      `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
</span><span style="color: #008080;">17</span> <span style="color: #008000;">    *       PRIMARY KEY (`id`)
</span><span style="color: #008080;">18</span> <span style="color: #008000;">    *   ) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8mb4;
</span><span style="color: #008080;">19</span>    <span style="color: #008000;">*/</span>
<span style="color: #008080;">20</span>     require_once <span style="color: #800000;">'</span><span style="color: #800000;">db.class.php</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">21</span>     $mysql      = <span style="color: #0000ff;">new</span><span style="color: #000000;"> \mysql();
</span><span style="color: #008080;">22</span>     $mysql-&gt;<span style="color: #000000;">connect();
</span><span style="color: #008080;">23</span>     $data       = [<span style="color: #800000;">'</span><span style="color: #800000;">ordersn</span><span style="color: #800000;">'</span>=&gt;$order_sn,<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>=&gt;<span style="color: #800080;">0</span>,<span style="color: #800000;">'</span><span style="color: #800000;">createtime</span><span style="color: #800000;">'</span>=&gt;date(<span style="color: #800000;">'</span><span style="color: #800000;">Y-m-d H:i:s</span><span style="color: #800000;">'</span><span style="color: #000000;">,time())];
</span><span style="color: #008080;">24</span>     $mysql-&gt;insert(<span style="color: #800000;">'</span><span style="color: #800000;">order</span><span style="color: #800000;">'</span><span style="color: #000000;">,$data);
</span><span style="color: #008080;">25</span> <span style="color: #000000;">}
</span><span style="color: #008080;">26</span> 
<span style="color: #008080;">27</span> $list =<span style="color: #000000;"> [$order_sn,$use_mysql];
</span><span style="color: #008080;">28</span> $key = implode(<span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span><span style="color: #000000;">,$list);
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span> $redis-&gt;setex($key,<span style="color: #800080;">3</span>,<span style="color: #800000;">'</span><span style="color: #800000;">redis延迟任务</span><span style="color: #800000;">'</span>);      <span style="color: #008000;">//</span><span style="color: #008000;">3秒后回调</span>
<span style="color: #008080;">31</span> 
<span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span> $test_del = <span style="color: #0000ff;">false</span>;      <span style="color: #008000;">//</span><span style="color: #008000;">测试删除缓存后是否会有过期回调。结果：没有回调</span>
<span style="color: #008080;">35</span> <span style="color: #0000ff;">if</span>($test_del == <span style="color: #0000ff;">true</span><span style="color: #000000;">){
</span><span style="color: #008080;">36</span>     <span style="color: #008000;">//</span><span style="color: #008000;">sleep(1);</span>
<span style="color: #008080;">37</span>     $redis-&gt;<span style="color: #000000;">delete($order_sn);
</span><span style="color: #008080;">38</span> <span style="color: #000000;">}
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> <span style="color: #000000;">echo $order_sn;
</span><span style="color: #008080;">41</span> 
<span style="color: #008080;">42</span> 
<span style="color: #008080;">43</span> 
<span style="color: #008080;">44</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">45</span> <span style="color: #008000;"> *   测试其他key会不会有回调，结果：有回调
</span><span style="color: #008080;">46</span> <span style="color: #008000;"> *   $k = 'test';
</span><span style="color: #008080;">47</span> <span style="color: #008000;"> *   $redis2-&gt;set($k,'100');
</span><span style="color: #008080;">48</span> <span style="color: #008000;"> *   $redis2-&gt;expire($k,10);
</span><span style="color: #008080;">49</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">50</span> <span style="color: #008000;">*/</span></code></pre>

<p>&nbsp;</p>

<p class="ztext-empty-paragraph">&nbsp;</p>
<p>psubscribe.php</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> ini_set(<span style="color: #800000;">'</span><span style="color: #800000;">default_socket_timeout</span><span style="color: #800000;">'</span>, -<span style="color: #800080;">1</span>);  <span style="color: #008000;">//</span><span style="color: #008000;">不超时</span>
<span style="color: #008080;"> 3</span> require_once <span style="color: #800000;">'</span><span style="color: #800000;">Redis2.class.php</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> $redis_db = <span style="color: #800000;">'</span><span style="color: #800000;">15</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span> $redis = <span style="color: #0000ff;">new</span> \Redis2(<span style="color: #800000;">'</span><span style="color: #800000;">127.0.0.1</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">6379</span><span style="color: #800000;">'</span>,<span style="color: #800000;">''</span><span style="color: #000000;">,$redis_db);
</span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 解决Redis客户端订阅时候超时情况</span>
<span style="color: #008080;"> 7</span> $redis-&gt;<span style="color: #000000;">setOption();
</span><span style="color: #008080;"> 8</span> <span style="color: #008000;">//</span><span style="color: #008000;">当key过期的时候就看到通知，订阅的key __keyevent@&lt;db&gt;__:expired 这个格式是固定的，db代表的是数据库的编号，由于订阅开启之后这个库的所有key过期时间都会被推送过来，所以最好单独使用一个数据库来进行隔离</span>
<span style="color: #008080;"> 9</span> $redis-&gt;psubscribe(array(<span style="color: #800000;">'</span><span style="color: #800000;">__keyevent@</span><span style="color: #800000;">'</span>.$redis_db.<span style="color: #800000;">'</span><span style="color: #800000;">__:expired</span><span style="color: #800000;">'</span>), <span style="color: #800000;">'</span><span style="color: #800000;">keyCallback</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">10</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 回调函数,这里写处理逻辑</span>
<span style="color: #008080;">11</span> <span style="color: #000000;">function keyCallback($redis, $pattern, $channel, $msg)
</span><span style="color: #008080;">12</span> <span style="color: #000000;">{
</span><span style="color: #008080;">13</span> <span style="color: #000000;">    echo PHP_EOL;
</span><span style="color: #008080;">14</span>     echo <span style="color: #800000;">"</span><span style="color: #800000;">Pattern: $pattern\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">15</span>     echo <span style="color: #800000;">"</span><span style="color: #800000;">Channel: $channel\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">16</span>     echo <span style="color: #800000;">"</span><span style="color: #800000;">Payload: $msg\n\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">17</span>     $list = explode(<span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span><span style="color: #000000;">,$msg);
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>     $order_sn = isset($list[<span style="color: #800080;">0</span>])?$list[<span style="color: #800080;">0</span>]:<span style="color: #800000;">'</span><span style="color: #800000;">0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">20</span>     $use_mysql = isset($list[<span style="color: #800080;">1</span>])?$list[<span style="color: #800080;">1</span>]:<span style="color: #800000;">'</span><span style="color: #800000;">0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>     <span style="color: #0000ff;">if</span>($use_mysql == <span style="color: #800080;">1</span><span style="color: #000000;">){
</span><span style="color: #008080;">23</span>         require_once <span style="color: #800000;">'</span><span style="color: #800000;">db.class.php</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">24</span>         $mysql = <span style="color: #0000ff;">new</span><span style="color: #000000;"> \mysql();
</span><span style="color: #008080;">25</span>         $mysql-&gt;<span style="color: #000000;">connect();
</span><span style="color: #008080;">26</span>         $<span style="color: #0000ff;">where</span> = <span style="color: #800000;">"</span><span style="color: #800000;">ordersn = '</span><span style="color: #800000;">"</span>.$order_sn.<span style="color: #800000;">"</span><span style="color: #800000;">'</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">27</span>         $mysql-&gt;<span style="color: #0000ff;">select</span>(<span style="color: #800000;">'</span><span style="color: #800000;">order</span><span style="color: #800000;">'</span>,<span style="color: #800000;">''</span>,$<span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">28</span>         $finds=$mysql-&gt;<span style="color: #000000;">fetchAll();
</span><span style="color: #008080;">29</span> <span style="color: #000000;">        print_r($finds);
</span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">if</span>(isset($finds[<span style="color: #800080;">0</span>][<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>]) &amp;&amp; $finds[<span style="color: #800080;">0</span>][<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>]==<span style="color: #800080;">0</span><span style="color: #000000;">){
</span><span style="color: #008080;">31</span>             $data   = array(<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span> =&gt; <span style="color: #800080;">3</span><span style="color: #000000;">);
</span><span style="color: #008080;">32</span>             $<span style="color: #0000ff;">where</span>  = <span style="color: #800000;">"</span><span style="color: #800000;"> id = </span><span style="color: #800000;">"</span>.$finds[<span style="color: #800080;">0</span>][<span style="color: #800000;">'</span><span style="color: #800000;">id</span><span style="color: #800000;">'</span><span style="color: #000000;">];
</span><span style="color: #008080;">33</span>             $mysql-&gt;update(<span style="color: #800000;">'</span><span style="color: #800000;">order</span><span style="color: #800000;">'</span>,$data,$<span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">34</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">35</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span> <span style="color: #000000;">}
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者</span>
<span style="color: #008080;">40</span> <span style="color: #008000;">/*</span><span style="color: #008000;">$redis-&gt;psubscribe(array('__keyevent@'.$redis_db.'__:expired'), function ($redis, $pattern, $channel, $msg){
</span><span style="color: #008080;">41</span> <span style="color: #008000;">    echo PHP_EOL;
</span><span style="color: #008080;">42</span> <span style="color: #008000;">    echo "Pattern: $pattern\n";
</span><span style="color: #008080;">43</span> <span style="color: #008000;">    echo "Channel: $channel\n";
</span><span style="color: #008080;">44</span> <span style="color: #008000;">    echo "Payload: $msg\n\n";
</span><span style="color: #008080;">45</span> <span style="color: #008000;">    //................
</span><span style="color: #008080;">46</span> <span style="color: #008000;">});</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">47</span>  </code></pre>

<p>&nbsp;</p>

<p>Redis2.class.php</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Redis2
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> $redis;
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> function __construct($host = <span style="color: #800000;">'</span><span style="color: #800000;">127.0.0.1</span><span style="color: #800000;">'</span>, $port = <span style="color: #800000;">'</span><span style="color: #800000;">6379</span><span style="color: #800000;">'</span>,$password = <span style="color: #800000;">''</span>,$db = <span style="color: #800000;">'</span><span style="color: #800000;">15</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 9</span>         $<span style="color: #0000ff;">this</span>-&gt;redis = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Redis();
</span><span style="color: #008080;">10</span>         $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;connect($host, $port);    <span style="color: #008000;">//</span><span style="color: #008000;">连接Redis</span>
<span style="color: #008080;">11</span>         $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;auth($password);      <span style="color: #008000;">//</span><span style="color: #008000;">密码验证</span>
<span style="color: #008080;">12</span>         $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #0000ff;">select</span>($db);    <span style="color: #008000;">//</span><span style="color: #008000;">选择数据库</span>
<span style="color: #008080;">13</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> function setex($key, $time, $val)
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #000000;">setex($key, $time, $val);
</span><span style="color: #008080;">18</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> function <span style="color: #0000ff;">set</span><span style="color: #000000;">($key, $val)
</span><span style="color: #008080;">21</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #0000ff;">set</span><span style="color: #000000;">($key, $val);
</span><span style="color: #008080;">23</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>     <span style="color: #0000ff;">public</span> function <span style="color: #0000ff;">get</span><span style="color: #000000;">($key)
</span><span style="color: #008080;">26</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #0000ff;">get</span><span style="color: #000000;">($key);
</span><span style="color: #008080;">28</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span> function expire($key = <span style="color: #0000ff;">null</span>, $time = <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #000000;">expire($key, $time);
</span><span style="color: #008080;">33</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">34</span> 
<span style="color: #008080;">35</span>     <span style="color: #0000ff;">public</span> function psubscribe($patterns =<span style="color: #000000;"> array(), $callback)
</span><span style="color: #008080;">36</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">37</span>         $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #000000;">psubscribe($patterns, $callback);
</span><span style="color: #008080;">38</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> function setOption()
</span><span style="color: #008080;">41</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">42</span>         $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;setOption(\Redis::OPT_READ_TIMEOUT, -<span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">43</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> function lRange($key,$start,$end)
</span><span style="color: #008080;">46</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">47</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;<span style="color: #000000;">lRange($key,$start,$end);
</span><span style="color: #008080;">48</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">49</span> 
<span style="color: #008080;">50</span>     <span style="color: #0000ff;">public</span> function lPush($key, $value1, $value2 = <span style="color: #0000ff;">null</span>, $valueN = <span style="color: #0000ff;">null</span><span style="color: #000000;"> ){
</span><span style="color: #008080;">51</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;lPush($key, $value1, $value2 = <span style="color: #0000ff;">null</span>, $valueN = <span style="color: #0000ff;">null</span><span style="color: #000000;"> );
</span><span style="color: #008080;">52</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">53</span> 
<span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> function delete($key1, $key2 = <span style="color: #0000ff;">null</span>, $key3 = <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">55</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">56</span>         <span style="color: #0000ff;">return</span> $<span style="color: #0000ff;">this</span>-&gt;redis-&gt;delete($key1, $key2 = <span style="color: #0000ff;">null</span>, $key3 = <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">57</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">58</span> 
<span style="color: #008080;">59</span> }</code></pre>

<p>&nbsp;</p>

<p class="ztext-empty-paragraph">&nbsp;</p>
<p>window系统测试方法：先在cmd命令界面运行psubscribe.php，然后网页打开index.php。3秒后效果如下</p>

<p>&nbsp;<img src="./images/PHP+Redis实现延迟任务，实现自动取消与完成订单1.jpg" alt="" /></p>
<src><br />
<src>
<h2><strong>使监听后台始终运行（订阅）</strong></h2>
<p> 有个问题 做到这一步，利用 phpredis 扩展，成功在代码里实现对过期 Key 的监听，并在 psCallback()里进行回调处理。 开头提出的两个需求已经实现。 可是这里有个问题：redis 在执行完订阅操作后，终端进入阻塞状态，需要一直挂在那。且此订阅脚本需要人为在命令行执行，不符合实际需求。</p>
<p>    实际上，我们对过期监听回调的需求，是希望它像守护进程一样，在后台运行，当有过期事件的消息时，触发回调函数。 使监听后台始终运行 希望像守护进程一样在后台一样，</p>
<p>我是这样实现的。</p>
<p>    Linux中有一个nohup命令。功能就是不挂断地运行命令。 同时nohup把脚本程序的所有输出，都放到当前目录的nohup.out文件中，如果文件不可写，则放到&lt;用户主目录&gt;/nohup.out 文件中。那么有了这个命令以后，不管我们终端窗口是否关闭，都能够让我们的php脚本一直运行。</p>
<p>编写psubscribe.php文件：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> #! /usr/bin/<span style="color: #000000;">env php
</span><span style="color: #008080;"> 3</span> ini_set(<span style="color: #800000;">'</span><span style="color: #800000;">default_socket_timeout</span><span style="color: #800000;">'</span>, -<span style="color: #800080;">1</span>);  <span style="color: #008000;">//</span><span style="color: #008000;">不超时</span>
<span style="color: #008080;"> 4</span> require_once <span style="color: #800000;">'</span><span style="color: #800000;">Redis2.class.php</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span> $redis_db = <span style="color: #800000;">'</span><span style="color: #800000;">15</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 6</span> $redis = <span style="color: #0000ff;">new</span> \Redis2(<span style="color: #800000;">'</span><span style="color: #800000;">127.0.0.1</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">6379</span><span style="color: #800000;">'</span>,<span style="color: #800000;">''</span><span style="color: #000000;">,$redis_db);
</span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 解决Redis客户端订阅时候超时情况</span>
<span style="color: #008080;"> 8</span> $redis-&gt;<span style="color: #000000;">setOption();
</span><span style="color: #008080;"> 9</span> <span style="color: #008000;">//</span><span style="color: #008000;">当key过期的时候就看到通知，订阅的key __keyevent@&lt;db&gt;__:expired 这个格式是固定的，db代表的是数据库的编号，由于订阅开启之后这个库的所有key过期时间都会被推送过来，所以最好单独使用一个数据库来进行隔离</span>
<span style="color: #008080;">10</span> $redis-&gt;psubscribe(array(<span style="color: #800000;">'</span><span style="color: #800000;">__keyevent@</span><span style="color: #800000;">'</span>.$redis_db.<span style="color: #800000;">'</span><span style="color: #800000;">__:expired</span><span style="color: #800000;">'</span>), <span style="color: #800000;">'</span><span style="color: #800000;">keyCallback</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">11</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 回调函数,这里写处理逻辑</span>
<span style="color: #008080;">12</span> <span style="color: #000000;">function keyCallback($redis, $pattern, $channel, $msg)
</span><span style="color: #008080;">13</span> <span style="color: #000000;">{
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    echo PHP_EOL;
</span><span style="color: #008080;">15</span>     echo <span style="color: #800000;">"</span><span style="color: #800000;">Pattern: $pattern\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">16</span>     echo <span style="color: #800000;">"</span><span style="color: #800000;">Channel: $channel\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">17</span>     echo <span style="color: #800000;">"</span><span style="color: #800000;">Payload: $msg\n\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">18</span>     $list = explode(<span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span><span style="color: #000000;">,$msg);
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span>     $order_sn = isset($list[<span style="color: #800080;">0</span>])?$list[<span style="color: #800080;">0</span>]:<span style="color: #800000;">'</span><span style="color: #800000;">0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">21</span>     $use_mysql = isset($list[<span style="color: #800080;">1</span>])?$list[<span style="color: #800080;">1</span>]:<span style="color: #800000;">'</span><span style="color: #800000;">0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span>     <span style="color: #0000ff;">if</span>($use_mysql == <span style="color: #800080;">1</span><span style="color: #000000;">){
</span><span style="color: #008080;">24</span>         require_once <span style="color: #800000;">'</span><span style="color: #800000;">db.class.php</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">25</span>         $mysql = <span style="color: #0000ff;">new</span><span style="color: #000000;"> \mysql();
</span><span style="color: #008080;">26</span>         $mysql-&gt;<span style="color: #000000;">connect();
</span><span style="color: #008080;">27</span>         $<span style="color: #0000ff;">where</span> = <span style="color: #800000;">"</span><span style="color: #800000;">ordersn = '</span><span style="color: #800000;">"</span>.$order_sn.<span style="color: #800000;">"</span><span style="color: #800000;">'</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">28</span>         $mysql-&gt;<span style="color: #0000ff;">select</span>(<span style="color: #800000;">'</span><span style="color: #800000;">order</span><span style="color: #800000;">'</span>,<span style="color: #800000;">''</span>,$<span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">29</span>         $finds=$mysql-&gt;<span style="color: #000000;">fetchAll();
</span><span style="color: #008080;">30</span> <span style="color: #000000;">        print_r($finds);
</span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">if</span>(isset($finds[<span style="color: #800080;">0</span>][<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>]) &amp;&amp; $finds[<span style="color: #800080;">0</span>][<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>]==<span style="color: #800080;">0</span><span style="color: #000000;">){
</span><span style="color: #008080;">32</span>             $data   = array(<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span> =&gt; <span style="color: #800080;">3</span><span style="color: #000000;">);
</span><span style="color: #008080;">33</span>             $<span style="color: #0000ff;">where</span>  = <span style="color: #800000;">"</span><span style="color: #800000;"> id = </span><span style="color: #800000;">"</span>.$finds[<span style="color: #800080;">0</span>][<span style="color: #800000;">'</span><span style="color: #800000;">id</span><span style="color: #800000;">'</span><span style="color: #000000;">];
</span><span style="color: #008080;">34</span>             $mysql-&gt;update(<span style="color: #800000;">'</span><span style="color: #800000;">order</span><span style="color: #800000;">'</span>,$data,$<span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">35</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">36</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">37</span> 
<span style="color: #008080;">38</span> <span style="color: #000000;">}
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> 
<span style="color: #008080;">41</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者</span>
<span style="color: #008080;">42</span> <span style="color: #008000;">/*</span><span style="color: #008000;">$redis-&gt;psubscribe(array('__keyevent@'.$redis_db.'__:expired'), function ($redis, $pattern, $channel, $msg){
</span><span style="color: #008080;">43</span> <span style="color: #008000;">    echo PHP_EOL;
</span><span style="color: #008080;">44</span> <span style="color: #008000;">    echo "Pattern: $pattern\n";
</span><span style="color: #008080;">45</span> <span style="color: #008000;">    echo "Channel: $channel\n";
</span><span style="color: #008080;">46</span> <span style="color: #008000;">    echo "Payload: $msg\n\n";
</span><span style="color: #008080;">47</span> <span style="color: #008000;">    //................
</span><span style="color: #008080;">48</span> <span style="color: #008000;">});</span><span style="color: #008000;">*/</span></code></pre>

<p>&nbsp;</p>

<p class="ztext-empty-paragraph">&nbsp;</p>
<p>注意：我们在开头，申明 php 编译器的路径：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>#! /usr/bin/env php</code></pre>

<p>&nbsp;</p>

<p>这是执行 php 脚本所必须的。</p>
<p>然后，nohup 不挂起执行 psubscribe.php，注意 末尾的 &amp;</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;">1</span> [root@chokingwin HiGirl]# nohup ./psubscribe.php &amp; 
<span style="color: #008080;">2</span> [<span style="color: #800080;">1</span>] <span style="color: #800080;">4456</span> nohup: ignoring input and appending output to `nohup.<span style="color: #0000ff;">out</span><span style="color: #800000;">'</span></code></pre>

<p>&nbsp;</p>

<p>说明：脚本确实已经在 4456 号进程上跑起来。</p>
<p>查看下nohup.out cat 一下 nohuo.out，看下是否有过期输出：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;">1</span> [root@chokingwin HiGirl]# cat nohup.<span style="color: #0000ff;">out</span> 
<span style="color: #008080;">2</span> <span style="color: #000000;">Pattern:__keyevent@0__:expired 
</span><span style="color: #008080;">3</span> <span style="color: #000000;">Channel: __keyevent@0__:expired 
</span><span style="color: #008080;">4</span> Payload: name</code></pre>

<p>&nbsp;</p>

<p>运行index.php ，3秒后效果如上即成功</p>
<p>遇到问题：使用命令行模式开启监控脚本 ，一段时间后报错 ：Error while sending QUERY packet. PID=xxx</p>
<p>解决方法：由于等待消息队列是一个长连接，而等待回调前有个数据库连接，数据库的wait_timeout=28800，所以只要下一条消息离上一条消息超过8小时，就会出现这个错误，把wait_timeout设置成10，并且捕获异常，发现真实的报错是 MySQL server has gone away ， 所以只要处理完所有业务逻辑后主动关闭数据库连接，即数据库连接主动close掉就可以解决问题</p>
<p>yii解决方法如下：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>Yii::$app-&gt;db-&gt;close();</code></pre>

<p>&nbsp;</p>

<p>查看进程方法：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code> ps -aux|<span style="color: #000000;">grep psubscribe.php
a:显示所有程序 
u:以用户为主的格式来显示 
x:显示所有程序，不以终端机来区分</span></code></pre>

<p>&nbsp;</p>

<p><strong>查看jobs进程ID：[ </strong>jobs -l <strong>]命令</strong></p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>www@iZ232eoxo41Z:~/tinywan $ jobs -<span style="color: #000000;">l
[</span><span style="color: #800080;">1</span>]-  <span style="color: #800080;">1365</span> Stopped (tty output)    sudo nohup psubscribe.php &gt; /dev/<span style="color: #0000ff;">null</span> <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span><span style="color: #000000;"> 
[</span><span style="color: #800080;">2</span>]+ <span style="color: #800080;">1370</span> Stopped (tty output) sudo nohup psubscribe.php &gt; /dev/<span style="color: #0000ff;">null</span> <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span></code></pre>

<p>&nbsp;</p>

<p>终止后台运行的进程方法：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>kill -<span style="color: #800080;">9</span>  进程号</code></pre>

<p>&nbsp;</p>

<p>清空 nohup.out文件方法：</p>
<src class="highlight">
<src class="cnblogs_code">
<pre><code>cat /dev/<span style="color: #0000ff;">null</span> &gt; nohup.<span style="color: #0000ff;">out</span></code></pre>

<p>&nbsp;</p>

<p>我们在使用nohup的时候，一般都和&amp;配合使用，但是在实际使用过程中，很多人后台挂上程序就这样不管了，其实这样有可能在当前账户非正常退出或者结束的时候，命令还是自己结束了。</p>
<p>所以在使用nohup命令后台运行命令之后，我们需要做以下操作：</p>
<src class="highlight">
<pre><code><code class="language-text">1.先回车，退出nohup的提示。
2.然后执行exit正常退出当前账户。
3.然后再去链接终端。使得程序后台正常运行。</code></code></pre>

<p>我们应该每次都使用exit退出，而不应该每次在nohup执行成功后直接关闭终端。这样才能保证命令一直在后台运行。</p>


<p>&nbsp;</p>
<p>&nbsp;很多PHPer在进阶的时候总会遇到一些问题和瓶颈，业务代码写多了没有方向感，不知道该从那里入手去提升，对此我整理了一些资料，包括但不限于：分布式架构、高可扩展、高性能、高并发、服务器性能调优、TP6，laravel，YII2，Redis，Swoole、Swoft、Kafka、Mysql优化、shell脚本、Docker、微服务、Nginx等多个知识点高级进阶干货需要的可以免费分享给大家<strong>，需要的加群（点击&rarr;）<a href="https://jq.qq.com/?_wv=1027&amp;k=5kN6y8c" data-cke-saved-href="https://jq.qq.com/?_wv=1027&amp;k=5kN6y8c">677079770</a></strong></p>

</div></div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>