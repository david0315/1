<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修用PHP+Redis实现延迟任务，实现自动取消订单' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>用PHP+Redis实现延迟任务，实现自动取消订单</center></div><div class='banquan'>原文出处:本文由博客园博主程序媛的明天提供。<br/>
原文连接:https://www.cnblogs.com/a609251438/p/11898872.html</div><br>
    <p>简单定时任务解决方案：使用redis的keyspace notifications（键失效后通知事件） 需要注意此功能是在redis 2.8版本以后推出的，因此你服务器上的reids最少要是2.8版本以上；</p>
<p>&nbsp;</p>
<p>(A)业务场景：</p>
<p>1、当一个业务触发以后需要启动一个定时任务，在指定时间内再去执行一个任务（如自动取消订单，自动完成订单等功能）</p>
<p>2、redis的keyspace notifications 会在key失效后发送一个事件，监听此事件的的客户端就可以收到通知</p>
<p>(B)服务准备：</p>
<p>1、修改reids配置文件（redis.conf）【window系统配置文件为：redis.windows.conf 】</p>
<p>redis默认不会开启keyspace notifications，因为开启后会对cpu有消耗</p>
<p>备注：E：keyevent事件，事件以__keyevent@&lt;db&gt;__为前缀进行发布；</p>
<p>x：过期事件，当某个键过期并删除时会产生该事件；</p>
<p>原配置为：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="18">
<pre><code><code class="hljs">notify-keyspace-events ""
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>更改 配置如下：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="17">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;notify-keyspace-events \&amp;quot;Ex\&amp;quot;\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">notify-keyspace-events "Ex"
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>保存配置后，重启Redis服务，使配置生效</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="16">
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">[root@chokingwin etc]#
service redis</span>-server restart /usr/local/redis/etc/<span style="color: #000000;">redis.conf 
Stopping redis</span>-<span style="color: #000000;">server: [ OK ] 
Starting redis</span>-server: [ OK ]</code></pre>

<p>&nbsp;</p>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>&nbsp;</p>
<p>window系统重启redis ，先切换到redis文件目录，然后关闭redis服务（redis-server --service-stop），再开启（redis-server --service-start）</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="图像" data-cke-widget-id="15"><img class="has cke_widget_element" src="./images/用PHP+Redis实现延迟任务，实现自动取消订单3.jpg" alt="" width="641" height="278" data-cke-saved-src="./images/用PHP+Redis实现延迟任务，实现自动取消订单3.jpg" data-cke-widget-data="{&amp;quot;hasCaption&amp;quot;:false,&amp;quot;src&amp;quot;:&amp;quot;./images/用PHP+Redis实现延迟任务，实现自动取消订单3.jpg&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;width&amp;quot;:&amp;quot;641&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;278&amp;quot;,&amp;quot;lock&amp;quot;:true,&amp;quot;align&amp;quot;:&amp;quot;none&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>C)文件代码：</p>
<p>phpredis实现订阅Keyspace notification,可实现自动取消订单，自动完成订单。以下为测试例子</p>
<p>创建4个文件，然后自行修改数据库和redis配置参数</p>
<p>db.class.php</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="14">
<src class="cnblogs_code">
<pre><code>&lt;?<span style="color: #000000;">php
</span><span style="color: #0000ff;">class</span> <span style="color: #008080;">mysql</span><span style="color: #000000;">
{
    </span><span style="color: #0000ff;">private</span> <span style="color: #800080;">$mysqli</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">private</span> <span style="color: #800080;">$result</span><span style="color: #000000;">;
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * 数据库连接
     * @param $config 配置数组
     </span><span style="color: #008000;">*/</span>

    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> connect()
    {
        </span><span style="color: #800080;">$config</span>=<span style="color: #0000ff;">array</span><span style="color: #000000;">(
            </span>'host'=&gt;'127.0.0.1',
            'username'=&gt;'root',
            'password'=&gt;'168168',
            'database'=&gt;'test',
            'port'=&gt;3306,<span style="color: #000000;">
        );

        </span><span style="color: #800080;">$host</span> = <span style="color: #800080;">$config</span>['host'];    <span style="color: #008000;">//</span><span style="color: #008000;">主机地址</span>
        <span style="color: #800080;">$username</span> = <span style="color: #800080;">$config</span>['username'];<span style="color: #008000;">//</span><span style="color: #008000;">用户名</span>
        <span style="color: #800080;">$password</span> = <span style="color: #800080;">$config</span>['password'];<span style="color: #008000;">//</span><span style="color: #008000;">密码</span>
        <span style="color: #800080;">$database</span> = <span style="color: #800080;">$config</span>['database'];<span style="color: #008000;">//</span><span style="color: #008000;">数据库</span>
        <span style="color: #800080;">$port</span> = <span style="color: #800080;">$config</span>['port'];    <span style="color: #008000;">//</span><span style="color: #008000;">端口号</span>
        <span style="color: #800080;">$this</span>-&gt;mysqli = <span style="color: #0000ff;">new</span> mysqli(<span style="color: #800080;">$host</span>, <span style="color: #800080;">$username</span>, <span style="color: #800080;">$password</span>, <span style="color: #800080;">$database</span>, <span style="color: #800080;">$port</span><span style="color: #000000;">);

    }
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * 数据查询
     * @param $table 数据表
     * @param null $field 字段
     * @param null $where 条件
     * @return mixed 查询结果数目
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> select(<span style="color: #800080;">$table</span>, <span style="color: #800080;">$field</span> = <span style="color: #0000ff;">null</span>, <span style="color: #800080;">$where</span> = <span style="color: #0000ff;">null</span><span style="color: #000000;">)
    {
        </span><span style="color: #800080;">$sql</span> = "SELECT * FROM `{<span style="color: #800080;">$table</span>}`"<span style="color: #000000;">;
        </span><span style="color: #008000;">//</span><span style="color: #008000;">echo $sql;exit;</span>
        <span style="color: #0000ff;">if</span> (!<span style="color: #0000ff;">empty</span>(<span style="color: #800080;">$field</span><span style="color: #000000;">)) {
            </span><span style="color: #800080;">$field</span> = '`' . <span style="color: #008080;">implode</span>('`,`', <span style="color: #800080;">$field</span>) . '`'<span style="color: #000000;">;
            </span><span style="color: #800080;">$sql</span> = <span style="color: #008080;">str_replace</span>('*', <span style="color: #800080;">$field</span>, <span style="color: #800080;">$sql</span><span style="color: #000000;">);
        }
        </span><span style="color: #0000ff;">if</span> (!<span style="color: #0000ff;">empty</span>(<span style="color: #800080;">$where</span><span style="color: #000000;">)) {
            </span><span style="color: #800080;">$sql</span> = <span style="color: #800080;">$sql</span> . ' WHERE ' . <span style="color: #800080;">$where</span><span style="color: #000000;">;
        }


        </span><span style="color: #800080;">$this</span>-&gt;result = <span style="color: #800080;">$this</span>-&gt;mysqli-&gt;query(<span style="color: #800080;">$sql</span><span style="color: #000000;">);

        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;<span style="color: #000000;">result;
    }
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * @return mixed 获取全部结果
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> fetchAll()
    {
        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;result-&gt;<span style="color: #000000;">fetch_all(MYSQLI_ASSOC);
    }
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * 插入数据
     * @param $table 数据表
     * @param $data 数据数组
     * @return mixed 插入ID
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> insert(<span style="color: #800080;">$table</span>, <span style="color: #800080;">$data</span><span style="color: #000000;">)
    {
        </span><span style="color: #0000ff;">foreach</span> (<span style="color: #800080;">$data</span> <span style="color: #0000ff;">as</span> <span style="color: #800080;">$key</span> =&gt; <span style="color: #800080;">$value</span><span style="color: #000000;">) {
            </span><span style="color: #800080;">$data</span>[<span style="color: #800080;">$key</span>] = <span style="color: #800080;">$this</span>-&gt;mysqli-&gt;real_escape_string(<span style="color: #800080;">$value</span><span style="color: #000000;">);
        }
        </span><span style="color: #800080;">$keys</span> = '`' . <span style="color: #008080;">implode</span>('`,`', <span style="color: #008080;">array_keys</span>(<span style="color: #800080;">$data</span>)) . '`'<span style="color: #000000;">;
        </span><span style="color: #800080;">$values</span> = '\'' . <span style="color: #008080;">implode</span>("','", <span style="color: #008080;">array_values</span>(<span style="color: #800080;">$data</span>)) . '\''<span style="color: #000000;">;
        </span><span style="color: #800080;">$sql</span> = "INSERT INTO `{<span style="color: #800080;">$table</span>}`( {<span style="color: #800080;">$keys</span>} )VALUES( {<span style="color: #800080;">$values</span>} )"<span style="color: #000000;">;
        </span><span style="color: #800080;">$this</span>-&gt;mysqli-&gt;query(<span style="color: #800080;">$sql</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;mysqli-&gt;<span style="color: #000000;">insert_id;
    }
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * 更新数据
     * @param $table 数据表
     * @param $data 数据数组
     * @param $where 过滤条件
     * @return mixed 受影响记录
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> update(<span style="color: #800080;">$table</span>, <span style="color: #800080;">$data</span>, <span style="color: #800080;">$where</span><span style="color: #000000;">)
    {
        </span><span style="color: #0000ff;">foreach</span> (<span style="color: #800080;">$data</span> <span style="color: #0000ff;">as</span> <span style="color: #800080;">$key</span> =&gt; <span style="color: #800080;">$value</span><span style="color: #000000;">) {
            </span><span style="color: #800080;">$data</span>[<span style="color: #800080;">$key</span>] = <span style="color: #800080;">$this</span>-&gt;mysqli-&gt;real_escape_string(<span style="color: #800080;">$value</span><span style="color: #000000;">);
        }
        </span><span style="color: #800080;">$sets</span> = <span style="color: #0000ff;">array</span><span style="color: #000000;">();
        </span><span style="color: #0000ff;">foreach</span> (<span style="color: #800080;">$data</span> <span style="color: #0000ff;">as</span> <span style="color: #800080;">$key</span> =&gt; <span style="color: #800080;">$value</span><span style="color: #000000;">) {
            </span><span style="color: #800080;">$kstr</span> = '`' . <span style="color: #800080;">$key</span> . '`'<span style="color: #000000;">;
            </span><span style="color: #800080;">$vstr</span> = '\'' . <span style="color: #800080;">$value</span> . '\''<span style="color: #000000;">;
            </span><span style="color: #008080;">array_push</span>(<span style="color: #800080;">$sets</span>, <span style="color: #800080;">$kstr</span> . '=' . <span style="color: #800080;">$vstr</span><span style="color: #000000;">);
        }
        </span><span style="color: #800080;">$kav</span> = <span style="color: #008080;">implode</span>(',', <span style="color: #800080;">$sets</span><span style="color: #000000;">);
        </span><span style="color: #800080;">$sql</span> = "UPDATE `{<span style="color: #800080;">$table</span>}` SET {<span style="color: #800080;">$kav</span>} WHERE {<span style="color: #800080;">$where</span>}"<span style="color: #000000;">;

        </span><span style="color: #800080;">$this</span>-&gt;mysqli-&gt;query(<span style="color: #800080;">$sql</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;mysqli-&gt;<span style="color: #000000;">affected_rows;
    }
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * 删除数据
     * @param $table 数据表
     * @param $where 过滤条件
     * @return mixed 受影响记录
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> delete(<span style="color: #800080;">$table</span>, <span style="color: #800080;">$where</span><span style="color: #000000;">)
    {
        </span><span style="color: #800080;">$sql</span> = "DELETE FROM `{<span style="color: #800080;">$table</span>}` WHERE {<span style="color: #800080;">$where</span>}"<span style="color: #000000;">;
        </span><span style="color: #800080;">$this</span>-&gt;mysqli-&gt;query(<span style="color: #800080;">$sql</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;mysqli-&gt;<span style="color: #000000;">affected_rows;
    }
}

 </span></code></pre>

<p>&nbsp;</p>

<p>index.php</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="13">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">require_once</span> 'Redis2.class.php'<span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span> <span style="color: #800080;">$redis</span> = <span style="color: #0000ff;">new</span> \Redis2('127.0.0.1','6379','','15'<span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> <span style="color: #800080;">$order_sn</span>   = 'SN'.<span style="color: #008080;">time</span>().'T'.<span style="color: #008080;">rand</span>(10000000,99999999<span style="color: #000000;">);
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> <span style="color: #800080;">$use_mysql</span> = 1;         <span style="color: #008000;">//</span><span style="color: #008000;">是否使用数据库，1使用，2不使用</span>
<span style="color: #008080;"> 9</span> <span style="color: #0000ff;">if</span>(<span style="color: #800080;">$use_mysql</span> == 1<span style="color: #000000;">){
</span><span style="color: #008080;">10</span>    <span style="color: #008000;">/*</span>
<span style="color: #008080;">11</span> <span style="color: #008000;">    *   //数据表
</span><span style="color: #008080;">12</span> <span style="color: #008000;">    *   CREATE TABLE `order` (
</span><span style="color: #008080;">13</span> <span style="color: #008000;">    *      `ordersn` varchar(255) NOT NULL DEFAULT '',
</span><span style="color: #008080;">14</span> <span style="color: #008000;">    *      `status` varchar(255) NOT NULL DEFAULT '',
</span><span style="color: #008080;">15</span> <span style="color: #008000;">    *      `createtime` varchar(255) NOT NULL DEFAULT '',
</span><span style="color: #008080;">16</span> <span style="color: #008000;">    *      `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
</span><span style="color: #008080;">17</span> <span style="color: #008000;">    *       PRIMARY KEY (`id`)
</span><span style="color: #008080;">18</span> <span style="color: #008000;">    *   ) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8mb4;
</span><span style="color: #008080;">19</span>    <span style="color: #008000;">*/</span>
<span style="color: #008080;">20</span>     <span style="color: #0000ff;">require_once</span> 'db.class.php'<span style="color: #000000;">;
</span><span style="color: #008080;">21</span>     <span style="color: #800080;">$mysql</span>      = <span style="color: #0000ff;">new</span> \<span style="color: #008080;">mysql</span><span style="color: #000000;">();
</span><span style="color: #008080;">22</span>     <span style="color: #800080;">$mysql</span>-&gt;<span style="color: #000000;">connect();
</span><span style="color: #008080;">23</span>     <span style="color: #800080;">$data</span>       = ['ordersn'=&gt;<span style="color: #800080;">$order_sn</span>,'status'=&gt;0,'createtime'=&gt;<span style="color: #008080;">date</span>('Y-m-d H:i:s',<span style="color: #008080;">time</span><span style="color: #000000;">())];
</span><span style="color: #008080;">24</span>     <span style="color: #800080;">$mysql</span>-&gt;insert('order',<span style="color: #800080;">$data</span><span style="color: #000000;">);
</span><span style="color: #008080;">25</span> <span style="color: #000000;">}
</span><span style="color: #008080;">26</span> 
<span style="color: #008080;">27</span> <span style="color: #800080;">$list</span> = [<span style="color: #800080;">$order_sn</span>,<span style="color: #800080;">$use_mysql</span><span style="color: #000000;">];
</span><span style="color: #008080;">28</span> <span style="color: #800080;">$key</span> = <span style="color: #008080;">implode</span>(':',<span style="color: #800080;">$list</span><span style="color: #000000;">);
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span> <span style="color: #800080;">$redis</span>-&gt;setex(<span style="color: #800080;">$key</span>,3,'redis延迟任务');      <span style="color: #008000;">//</span><span style="color: #008000;">3秒后回调</span>
<span style="color: #008080;">31</span> 
<span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span> <span style="color: #800080;">$test_del</span> = <span style="color: #0000ff;">false</span>;      <span style="color: #008000;">//</span><span style="color: #008000;">测试删除缓存后是否会有过期回调。结果：没有回调</span>
<span style="color: #008080;">35</span> <span style="color: #0000ff;">if</span>(<span style="color: #800080;">$test_del</span> == <span style="color: #0000ff;">true</span><span style="color: #000000;">){
</span><span style="color: #008080;">36</span>     <span style="color: #008000;">//</span><span style="color: #008000;">sleep(1);</span>
<span style="color: #008080;">37</span>     <span style="color: #800080;">$redis</span>-&gt;delete(<span style="color: #800080;">$order_sn</span><span style="color: #000000;">);
</span><span style="color: #008080;">38</span> <span style="color: #000000;">}
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> <span style="color: #0000ff;">echo</span> <span style="color: #800080;">$order_sn</span><span style="color: #000000;">;
</span><span style="color: #008080;">41</span> 
<span style="color: #008080;">42</span> 
<span style="color: #008080;">43</span> 
<span style="color: #008080;">44</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;">45</span> <span style="color: #008000;"> *   测试其他key会不会有回调，结果：有回调
</span><span style="color: #008080;">46</span> <span style="color: #008000;"> *   $k = 'test';
</span><span style="color: #008080;">47</span> <span style="color: #008000;"> *   $redis2-&gt;set($k,'100');
</span><span style="color: #008080;">48</span> <span style="color: #008000;"> *   $redis2-&gt;expire($k,10);
</span><span style="color: #008080;">49</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">50</span> <span style="color: #008000;">*/</span></code></pre>

<p>&nbsp;</p>

<p>&nbsp;</p>
<p>psubscribe.php</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="12">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> <span style="color: #008080;">ini_set</span>('default_socket_timeout', -1);  <span style="color: #008000;">//</span><span style="color: #008000;">不超时</span>
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">require_once</span> 'Redis2.class.php'<span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> <span style="color: #800080;">$redis_db</span> = '15'<span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span> <span style="color: #800080;">$redis</span> = <span style="color: #0000ff;">new</span> \Redis2('127.0.0.1','6379','',<span style="color: #800080;">$redis_db</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 解决Redis客户端订阅时候超时情况</span>
<span style="color: #008080;"> 7</span> <span style="color: #800080;">$redis</span>-&gt;<span style="color: #000000;">setOption();
</span><span style="color: #008080;"> 8</span> <span style="color: #008000;">//</span><span style="color: #008000;">当key过期的时候就看到通知，订阅的key __keyevent@&lt;db&gt;__:expired 这个格式是固定的，db代表的是数据库的编号，由于订阅开启之后这个库的所有key过期时间都会被推送过来，所以最好单独使用一个数据库来进行隔离</span>
<span style="color: #008080;"> 9</span> <span style="color: #800080;">$redis</span>-&gt;psubscribe(<span style="color: #0000ff;">array</span>('__keyevent@'.<span style="color: #800080;">$redis_db</span>.'__:expired'), 'keyCallback'<span style="color: #000000;">);
</span><span style="color: #008080;">10</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 回调函数,这里写处理逻辑</span>
<span style="color: #008080;">11</span> <span style="color: #0000ff;">function</span> keyCallback(<span style="color: #800080;">$redis</span>, <span style="color: #800080;">$pattern</span>, <span style="color: #800080;">$channel</span>, <span style="color: #800080;">$msg</span><span style="color: #000000;">)
</span><span style="color: #008080;">12</span> <span style="color: #000000;">{
</span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">echo</span> <span style="color: #ff00ff;">PHP_EOL</span><span style="color: #000000;">;
</span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">echo</span> "Pattern: <span style="color: #800080;">$pattern</span>\n"<span style="color: #000000;">;
</span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">echo</span> "Channel: <span style="color: #800080;">$channel</span>\n"<span style="color: #000000;">;
</span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">echo</span> "Payload: <span style="color: #800080;">$msg</span>\n\n"<span style="color: #000000;">;
</span><span style="color: #008080;">17</span>     <span style="color: #800080;">$list</span> = <span style="color: #008080;">explode</span>(':',<span style="color: #800080;">$msg</span><span style="color: #000000;">);
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>     <span style="color: #800080;">$order_sn</span> = <span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$list</span>[0])?<span style="color: #800080;">$list</span>[0]:'0'<span style="color: #000000;">;
</span><span style="color: #008080;">20</span>     <span style="color: #800080;">$use_mysql</span> = <span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$list</span>[1])?<span style="color: #800080;">$list</span>[1]:'0'<span style="color: #000000;">;
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>     <span style="color: #0000ff;">if</span>(<span style="color: #800080;">$use_mysql</span> == 1<span style="color: #000000;">){
</span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">require_once</span> 'db.class.php'<span style="color: #000000;">;
</span><span style="color: #008080;">24</span>         <span style="color: #800080;">$mysql</span> = <span style="color: #0000ff;">new</span> \<span style="color: #008080;">mysql</span><span style="color: #000000;">();
</span><span style="color: #008080;">25</span>         <span style="color: #800080;">$mysql</span>-&gt;<span style="color: #000000;">connect();
</span><span style="color: #008080;">26</span>         <span style="color: #800080;">$where</span> = "ordersn = '".<span style="color: #800080;">$order_sn</span>."'"<span style="color: #000000;">;
</span><span style="color: #008080;">27</span>         <span style="color: #800080;">$mysql</span>-&gt;select('order','',<span style="color: #800080;">$where</span><span style="color: #000000;">);
</span><span style="color: #008080;">28</span>         <span style="color: #800080;">$finds</span>=<span style="color: #800080;">$mysql</span>-&gt;<span style="color: #000000;">fetchAll();
</span><span style="color: #008080;">29</span>         <span style="color: #008080;">print_r</span>(<span style="color: #800080;">$finds</span><span style="color: #000000;">);
</span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$finds</span>[0]['status']) &amp;&amp; <span style="color: #800080;">$finds</span>[0]['status']==0<span style="color: #000000;">){
</span><span style="color: #008080;">31</span>             <span style="color: #800080;">$data</span>   = <span style="color: #0000ff;">array</span>('status' =&gt; 3<span style="color: #000000;">);
</span><span style="color: #008080;">32</span>             <span style="color: #800080;">$where</span>  = " id = ".<span style="color: #800080;">$finds</span>[0]['id'<span style="color: #000000;">];
</span><span style="color: #008080;">33</span>             <span style="color: #800080;">$mysql</span>-&gt;update('order',<span style="color: #800080;">$data</span>,<span style="color: #800080;">$where</span><span style="color: #000000;">);
</span><span style="color: #008080;">34</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">35</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span> <span style="color: #000000;">}
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者</span>
<span style="color: #008080;">41</span> <span style="color: #008000;">/*</span><span style="color: #008000;">$redis-&gt;psubscribe(array('__keyevent@'.$redis_db.'__:expired'), function ($redis, $pattern, $channel, $msg){
</span><span style="color: #008080;">42</span> <span style="color: #008000;">    echo PHP_EOL;
</span><span style="color: #008080;">43</span> <span style="color: #008000;">    echo "Pattern: $pattern\n";
</span><span style="color: #008080;">44</span> <span style="color: #008000;">    echo "Channel: $channel\n";
</span><span style="color: #008080;">45</span> <span style="color: #008000;">    echo "Payload: $msg\n\n";
</span><span style="color: #008080;">46</span> <span style="color: #008000;">    //................
</span><span style="color: #008080;">47</span> <span style="color: #008000;">});</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span>  </code></pre>

<p>&nbsp;</p>

<p>Redis2.class.php</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="11">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Redis2
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">private</span> <span style="color: #800080;">$redis</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> __construct(<span style="color: #800080;">$host</span> = '127.0.0.1', <span style="color: #800080;">$port</span> = '6379',<span style="color: #800080;">$password</span> = '',<span style="color: #800080;">$db</span> = '15'<span style="color: #000000;">)
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 9</span>         <span style="color: #800080;">$this</span>-&gt;redis = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Redis();
</span><span style="color: #008080;">10</span>         <span style="color: #800080;">$this</span>-&gt;redis-&gt;connect(<span style="color: #800080;">$host</span>, <span style="color: #800080;">$port</span>);    <span style="color: #008000;">//</span><span style="color: #008000;">连接Redis</span>
<span style="color: #008080;">11</span>         <span style="color: #800080;">$this</span>-&gt;redis-&gt;auth(<span style="color: #800080;">$password</span>);      <span style="color: #008000;">//</span><span style="color: #008000;">密码验证</span>
<span style="color: #008080;">12</span>         <span style="color: #800080;">$this</span>-&gt;redis-&gt;select(<span style="color: #800080;">$db</span>);    <span style="color: #008000;">//</span><span style="color: #008000;">选择数据库</span>
<span style="color: #008080;">13</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> setex(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$time</span>, <span style="color: #800080;">$val</span><span style="color: #000000;">)
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;setex(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$time</span>, <span style="color: #800080;">$val</span><span style="color: #000000;">);
</span><span style="color: #008080;">18</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> set(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$val</span><span style="color: #000000;">)
</span><span style="color: #008080;">21</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;set(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$val</span><span style="color: #000000;">);
</span><span style="color: #008080;">23</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> get(<span style="color: #800080;">$key</span><span style="color: #000000;">)
</span><span style="color: #008080;">26</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;get(<span style="color: #800080;">$key</span><span style="color: #000000;">);
</span><span style="color: #008080;">28</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> expire(<span style="color: #800080;">$key</span> = <span style="color: #0000ff;">null</span>, <span style="color: #800080;">$time</span> = 0<span style="color: #000000;">)
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;expire(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$time</span><span style="color: #000000;">);
</span><span style="color: #008080;">33</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">34</span> 
<span style="color: #008080;">35</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> psubscribe(<span style="color: #800080;">$patterns</span> = <span style="color: #0000ff;">array</span>(), <span style="color: #800080;">$callback</span><span style="color: #000000;">)
</span><span style="color: #008080;">36</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">37</span>         <span style="color: #800080;">$this</span>-&gt;redis-&gt;psubscribe(<span style="color: #800080;">$patterns</span>, <span style="color: #800080;">$callback</span><span style="color: #000000;">);
</span><span style="color: #008080;">38</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> setOption()
</span><span style="color: #008080;">41</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">42</span>         <span style="color: #800080;">$this</span>-&gt;redis-&gt;setOption(\Redis::OPT_READ_TIMEOUT, -1<span style="color: #000000;">);
</span><span style="color: #008080;">43</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> lRange(<span style="color: #800080;">$key</span>,<span style="color: #800080;">$start</span>,<span style="color: #800080;">$end</span><span style="color: #000000;">)
</span><span style="color: #008080;">46</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">47</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;lRange(<span style="color: #800080;">$key</span>,<span style="color: #800080;">$start</span>,<span style="color: #800080;">$end</span><span style="color: #000000;">);
</span><span style="color: #008080;">48</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">49</span> 
<span style="color: #008080;">50</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> lPush(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$value1</span>, <span style="color: #800080;">$value2</span> = <span style="color: #0000ff;">null</span>, <span style="color: #800080;">$valueN</span> = <span style="color: #0000ff;">null</span><span style="color: #000000;"> ){
</span><span style="color: #008080;">51</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;lPush(<span style="color: #800080;">$key</span>, <span style="color: #800080;">$value1</span>, <span style="color: #800080;">$value2</span> = <span style="color: #0000ff;">null</span>, <span style="color: #800080;">$valueN</span> = <span style="color: #0000ff;">null</span><span style="color: #000000;"> );
</span><span style="color: #008080;">52</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">53</span> 
<span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">function</span> delete(<span style="color: #800080;">$key1</span>, <span style="color: #800080;">$key2</span> = <span style="color: #0000ff;">null</span>, <span style="color: #800080;">$key3</span> = <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">55</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">56</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">$this</span>-&gt;redis-&gt;delete(<span style="color: #800080;">$key1</span>, <span style="color: #800080;">$key2</span> = <span style="color: #0000ff;">null</span>, <span style="color: #800080;">$key3</span> = <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">57</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">58</span> 
<span style="color: #008080;">59</span> }</code></pre>

<p>&nbsp;</p>

<p>&nbsp;</p>
<p>window系统测试方法：先在cmd命令界面运行psubscribe.php，然后网页打开index.php。</p>
<h2>使监听后台始终运行（订阅）</h2>
<p>有个问题 做到这一步，利用 phpredis 扩展，成功在代码里实现对过期 Key 的监听，并在 psCallback()里进行回调处理。开头提出的两个需求已经实现。可是这里有个问题：redis 在执行完订阅操作后，终端进入阻塞状态，需要一直挂在那。且此订阅脚本需要人为在命令行执行，不符合实际需求。</p>
<p>实际上，我们对过期监听回调的需求，是希望它像守护进程一样，在后台运行，当有过期事件的消息时，触发回调函数。使监听后台始终运行 希望像守护进程一样在后台一样，</p>
<p>我是这样实现的。</p>
<p>Linux中有一个nohup命令。功能就是不挂断地运行命令。同时nohup把脚本程序的所有输出，都放到当前目录的nohup.out文件中，如果文件不可写，则放到&lt;用户主目录&gt;/nohup.out 文件中。那么有了这个命令以后，不管我们终端窗口是否关闭，都能够让我们的php脚本一直运行。</p>
<p>编写psubscribe.php文件：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="10">
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> &lt;?<span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> <span style="color: #008000;">#</span><span style="color: #008000;">! /usr/bin/env php</span>
<span style="color: #008080;"> 3</span> <span style="color: #008080;">ini_set</span>('default_socket_timeout', -1);  <span style="color: #008000;">//</span><span style="color: #008000;">不超时</span>
<span style="color: #008080;"> 4</span> <span style="color: #0000ff;">require_once</span> 'Redis2.class.php'<span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span> <span style="color: #800080;">$redis_db</span> = '15'<span style="color: #000000;">;
</span><span style="color: #008080;"> 6</span> <span style="color: #800080;">$redis</span> = <span style="color: #0000ff;">new</span> \Redis2('127.0.0.1','6379','',<span style="color: #800080;">$redis_db</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 解决Redis客户端订阅时候超时情况</span>
<span style="color: #008080;"> 8</span> <span style="color: #800080;">$redis</span>-&gt;<span style="color: #000000;">setOption();
</span><span style="color: #008080;"> 9</span> <span style="color: #008000;">//</span><span style="color: #008000;">当key过期的时候就看到通知，订阅的key __keyevent@&lt;db&gt;__:expired 这个格式是固定的，db代表的是数据库的编号，由于订阅开启之后这个库的所有key过期时间都会被推送过来，所以最好单独使用一个数据库来进行隔离</span>
<span style="color: #008080;">10</span> <span style="color: #800080;">$redis</span>-&gt;psubscribe(<span style="color: #0000ff;">array</span>('__keyevent@'.<span style="color: #800080;">$redis_db</span>.'__:expired'), 'keyCallback'<span style="color: #000000;">);
</span><span style="color: #008080;">11</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 回调函数,这里写处理逻辑</span>
<span style="color: #008080;">12</span> <span style="color: #0000ff;">function</span> keyCallback(<span style="color: #800080;">$redis</span>, <span style="color: #800080;">$pattern</span>, <span style="color: #800080;">$channel</span>, <span style="color: #800080;">$msg</span><span style="color: #000000;">)
</span><span style="color: #008080;">13</span> <span style="color: #000000;">{
</span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">echo</span> <span style="color: #ff00ff;">PHP_EOL</span><span style="color: #000000;">;
</span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">echo</span> "Pattern: <span style="color: #800080;">$pattern</span>\n"<span style="color: #000000;">;
</span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">echo</span> "Channel: <span style="color: #800080;">$channel</span>\n"<span style="color: #000000;">;
</span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">echo</span> "Payload: <span style="color: #800080;">$msg</span>\n\n"<span style="color: #000000;">;
</span><span style="color: #008080;">18</span>     <span style="color: #800080;">$list</span> = <span style="color: #008080;">explode</span>(':',<span style="color: #800080;">$msg</span><span style="color: #000000;">);
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span>     <span style="color: #800080;">$order_sn</span> = <span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$list</span>[0])?<span style="color: #800080;">$list</span>[0]:'0'<span style="color: #000000;">;
</span><span style="color: #008080;">21</span>     <span style="color: #800080;">$use_mysql</span> = <span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$list</span>[1])?<span style="color: #800080;">$list</span>[1]:'0'<span style="color: #000000;">;
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span>     <span style="color: #0000ff;">if</span>(<span style="color: #800080;">$use_mysql</span> == 1<span style="color: #000000;">){
</span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">require_once</span> 'db.class.php'<span style="color: #000000;">;
</span><span style="color: #008080;">25</span>         <span style="color: #800080;">$mysql</span> = <span style="color: #0000ff;">new</span> \<span style="color: #008080;">mysql</span><span style="color: #000000;">();
</span><span style="color: #008080;">26</span>         <span style="color: #800080;">$mysql</span>-&gt;<span style="color: #000000;">connect();
</span><span style="color: #008080;">27</span>         <span style="color: #800080;">$where</span> = "ordersn = '".<span style="color: #800080;">$order_sn</span>."'"<span style="color: #000000;">;
</span><span style="color: #008080;">28</span>         <span style="color: #800080;">$mysql</span>-&gt;select('order','',<span style="color: #800080;">$where</span><span style="color: #000000;">);
</span><span style="color: #008080;">29</span>         <span style="color: #800080;">$finds</span>=<span style="color: #800080;">$mysql</span>-&gt;<span style="color: #000000;">fetchAll();
</span><span style="color: #008080;">30</span>         <span style="color: #008080;">print_r</span>(<span style="color: #800080;">$finds</span><span style="color: #000000;">);
</span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">isset</span>(<span style="color: #800080;">$finds</span>[0]['status']) &amp;&amp; <span style="color: #800080;">$finds</span>[0]['status']==0<span style="color: #000000;">){
</span><span style="color: #008080;">32</span>             <span style="color: #800080;">$data</span>   = <span style="color: #0000ff;">array</span>('status' =&gt; 3<span style="color: #000000;">);
</span><span style="color: #008080;">33</span>             <span style="color: #800080;">$where</span>  = " id = ".<span style="color: #800080;">$finds</span>[0]['id'<span style="color: #000000;">];
</span><span style="color: #008080;">34</span>             <span style="color: #800080;">$mysql</span>-&gt;update('order',<span style="color: #800080;">$data</span>,<span style="color: #800080;">$where</span><span style="color: #000000;">);
</span><span style="color: #008080;">35</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">36</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">37</span> 
<span style="color: #008080;">38</span> <span style="color: #000000;">}
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> 
<span style="color: #008080;">41</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者</span>
<span style="color: #008080;">42</span> <span style="color: #008000;">/*</span><span style="color: #008000;">$redis-&gt;psubscribe(array('__keyevent@'.$redis_db.'__:expired'), function ($redis, $pattern, $channel, $msg){
</span><span style="color: #008080;">43</span> <span style="color: #008000;">    echo PHP_EOL;
</span><span style="color: #008080;">44</span> <span style="color: #008000;">    echo "Pattern: $pattern\n";
</span><span style="color: #008080;">45</span> <span style="color: #008000;">    echo "Channel: $channel\n";
</span><span style="color: #008080;">46</span> <span style="color: #008000;">    echo "Payload: $msg\n\n";
</span><span style="color: #008080;">47</span> <span style="color: #008000;">    //................
</span><span style="color: #008080;">48</span> <span style="color: #008000;">});</span><span style="color: #008000;">*/</span></code></pre>

<p>&nbsp;</p>

<p>&nbsp;</p>
<p>注意：我们在开头，申明 php 编译器的路径：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="9">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;#! /usr/bin/env php\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">#! /usr/bin/env php
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>这是执行 php 脚本所必须的。</p>
<p>然后，nohup 不挂起执行 psubscribe.php，注意 末尾的 &amp;</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="8">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;[root@chokingwin HiGirl]# nohup ./psubscribe.php &amp;amp; \n[1] 4456 nohup: ignoring input and appending output to `nohup.out'\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">[root@chokingwin HiGirl]# nohup ./psubscribe.php &amp; 
[1] 4456 nohup: ignoring input and appending output to `nohup.out'
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>&nbsp;</p>
<p>说明：脚本确实已经在 4456 号进程上跑起来。</p>
<p>查看下nohup.out cat 一下 nohuo.out，看下是否有过期输出：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="7">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;[root@chokingwin HiGirl]# cat nohup.out \nPattern:__keyevent@0__:expired \nChannel: __keyevent@0__:expired \nPayload: name\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">[root@chokingwin HiGirl]# cat nohup.out 
Pattern:__keyevent@0__:expired 
Channel: __keyevent@0__:expired 
Payload: name
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>&nbsp;</p>
<p>运行index.php ，3秒后效果如上即成功</p>
<p>遇到问题：使用命令行模式开启监控脚本 ，一段时间后报错 ：Error while sending QUERY packet. PID=xxx</p>
<p>解决方法：由于等待消息队列是一个长连接，而等待回调前有个数据库连接，数据库的wait_timeout=28800，所以只要下一条消息离上一条消息超过8小时，就会出现这个错误，把wait_timeout设置成10，并且捕获异常，发现真实的报错是 MySQL server has gone away ，<br />所以只要处理完所有业务逻辑后主动关闭数据库连接，即数据库连接主动close掉就可以解决问题</p>
<p>yii解决方法如下：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="6">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;Yii::$app-&amp;gt;db-&amp;gt;close();\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">Yii::$app-&gt;db-&gt;close();
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>查看进程方法：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="5">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot; ps -aux|grep psubscribe.php\n\na:显示所有程序\nu:以用户为主的格式来显示\nx:显示所有程序，不以终端机来区分&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs"> ps -aux|grep psubscribe.php

a:显示所有程序
u:以用户为主的格式来显示
x:显示所有程序，不以终端机来区分</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p><strong>查看jobs进程ID：[ jobs -l ]命令</strong></p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="4">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;www@iZ232eoxo41Z:~/tinywan $ jobs -l\n[1]-  1365 Stopped (tty output)    sudo nohup psubscribe.php &amp;gt; /dev/null 2&amp;gt;&amp;amp;1 \n[2]+ 1370 Stopped (tty output) sudo nohup psubscribe.php &amp;gt; /dev/null 2&amp;gt;&amp;amp;1\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">www@iZ232eoxo41Z:~/tinywan $ jobs -l
[1]-  1365 Stopped (tty output)    sudo nohup psubscribe.php &gt; /dev/null 2&gt;&amp;1 
[2]+ 1370 Stopped (tty output) sudo nohup psubscribe.php &gt; /dev/null 2&gt;&amp;1
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>终止后台运行的进程方法：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="3">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;kill -9  进程号\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">kill -9  进程号
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>清空 nohup.out文件方法：</p>
<src class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="2">
<pre class="has cke_widget_element" data-cke-widget-data="{&amp;quot;code&amp;quot;:&amp;quot;cat /dev/null &amp;gt; nohup.out\n&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="codeSnippet"><code class="hljs">cat /dev/null &gt; nohup.out
</code></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span>
<p>我们在使用nohup的时候，一般都和&amp;配合使用，但是在实际使用过程中，很多人后台挂上程序就这样不管了，其实这样有可能在当前账户非正常退出或者结束的时候，命令还是自己结束了。</p>
<p>所以在使用nohup命令后台运行命令之后，我们需要做以下操作：</p>
<p>1.先回车，退出nohup的提示。</p>
<p>2.然后执行exit正常退出当前账户。<br />3.然后再去链接终端。使得程序后台正常运行。</p>
<p>我们应该每次都使用exit退出，而不应该每次在nohup执行成功后直接关闭终端。这样才能保证命令一直在后台运行。</p>
<p>&nbsp;</p>
<p><strong>推荐阅读：</strong></p>
<p><strong><a class="postTitle2" href="https://www.cnblogs.com/a609251438/p/11911950.html">PHP操作Redis数据库常用方法</a></strong></p>
<p><strong><a class="postTitle2" href="https://www.cnblogs.com/a609251438/p/11908261.html">php+redis实现注册、删除、编辑、分页、登录、关注等功能</a></strong></p>
<p><strong><a class="postTitle2" href="https://www.cnblogs.com/a609251438/p/11905420.html">Swoole和Redis实现的并发队列处理系统</a></strong></p>
<p><strong><a href="https://www.cnblogs.com/a609251438/p/11835819.html" target="_blank">Laravel 下配置&nbsp;Redis&nbsp;让缓存、Session 各自使用不同的&nbsp;Redis&nbsp;数据库</a></strong></p>
<p><strong>很<strong>多PHPer在进阶的时候总会遇到一些问题和瓶颈，业务代码写多了没有方向感，不知道该从那里入手去提升，对此我整理了一些资料，包括但不限于：分布式架构、高可扩展、高性能、高并发、服务器性能调优、TP6，laravel，YII2，Redis，Swoole、Swoft、Kafka、Mysql优化、shell脚本、Docker、微服务、Nginx等多个知识点高级进阶干货需要的可以免费分享给大家，需要的加群（点击&rarr;）<a href="https://jq.qq.com/?_wv=1027&amp;k=5kN6y8c" target="_blank">677079770</a></strong></strong></p>

</div></div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>