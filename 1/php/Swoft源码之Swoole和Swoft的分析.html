<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Swoft源码之Swoole和Swoft的分析' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Swoft源码之Swoole和Swoft的分析</center></div><div class='banquan'>原文出处:本文由博客园博主.Ronin提供。<br/>
原文连接:https://www.cnblogs.com/heyue0117/p/11809121.html</div><br>
    <p>这篇文章给大家分享的内容是关于Swoft 源码剖析之Swoole和Swoft的一些介绍(Task投递/定时任务篇），有一定的参考价值，有需要的朋友可以参考一下。</p>
<p>&nbsp;</p>
<h2>前言</h2>
<p><code>Swoft</code>的任务功能基于<code>Swoole</code>的<code>Task机制</code>，或者说<code>Swoft</code>的<code>Task</code>机制本质就是对<code>Swoole</code>的<code>Task机制</code>的封装和加强。</p>
<h2>任务投递</h2>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>
<p class="line number35 index34 alt2">35</p>
<p class="line number36 index35 alt1">36</p>
<p class="line number37 index36 alt2">37</p>
<p class="line number38 index37 alt1">38</p>
<p class="line number39 index38 alt2">39</p>
<p class="line number40 index39 alt1">40</p>
<p class="line number41 index40 alt2">41</p>
<p class="line number42 index41 alt1">42</p>
<p class="line number43 index42 alt2">43</p>
<p class="line number44 index43 alt1">44</p>
<p class="line number45 index44 alt2">45</p>
</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Task.php</code></p>
<p class="line number2 index1 alt1"><code class="php keyword">class</code> <code class="php plain">Task</code></p>
<p class="line number3 index2 alt2"><code class="php plain">{</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/**</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* Deliver coroutine or async task</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param string $taskName</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param string $methodName</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param array&nbsp; $params</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param string $type</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp; $timeout</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @return bool|array</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @throws TaskException</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">public</code> <code class="php keyword">static</code> <code class="php keyword">function</code> <code class="php plain">deliver(string </code><code class="php variable">$taskName</code><code class="php plain">, string </code><code class="php variable">$methodName</code><code class="php plain">, </code><code class="php keyword">array</code> <code class="php variable">$params</code> <code class="php plain">= [], string </code><code class="php variable">$type</code> <code class="php plain">= self::TYPE_CO, </code><code class="php variable">$timeout</code> <code class="php plain">= 3)</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$data</code>&nbsp;&nbsp; <code class="php plain">= TaskHelper::pack(</code><code class="php variable">$taskName</code><code class="php plain">, </code><code class="php variable">$methodName</code><code class="php plain">, </code><code class="php variable">$params</code><code class="php plain">, </code><code class="php variable">$type</code><code class="php plain">);</code></p>
<p class="line number19 index18 alt2">&nbsp;</p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code><code class="php plain">(!App::isWorkerStatus() &amp;&amp; !App::isCoContext()){</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">self::deliverByQueue(</code><code class="php variable">$data</code><code class="php plain">);</code><code class="php comments">//见下文Command章节</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number23 index22 alt2">&nbsp;</p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code><code class="php plain">(!App::isWorkerStatus() &amp;&amp; App::isCoContext()){</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">throw</code> <code class="php keyword">new</code> <code class="php plain">TaskException(</code><code class="php string">'Please deliver task by http!'</code><code class="php plain">);</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number27 index26 alt2">&nbsp;</p>
<p class="line number28 index27 alt1">&nbsp;</p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code> <code class="php plain">= App::</code><code class="php variable">$server</code><code class="php plain">-&gt;getServer();</code></p>
<p class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Delier coroutine task</code></p>
<p class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$type</code> <code class="php plain">== self::TYPE_CO) {</code></p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$tasks</code><code class="php plain">[0]&nbsp; = </code><code class="php variable">$data</code><code class="php plain">;</code></p>
<p class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$prifleKey</code> <code class="php plain">= </code><code class="php string">'task'</code> <code class="php plain">. </code><code class="php string">'.'</code> <code class="php plain">. </code><code class="php variable">$taskName</code> <code class="php plain">. </code><code class="php string">'.'</code> <code class="php plain">. </code><code class="php variable">$methodName</code><code class="php plain">;</code></p>
<p class="line number34 index33 alt1">&nbsp;</p>
<p class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">App::profileStart(</code><code class="php variable">$prifleKey</code><code class="php plain">);</code></p>
<p class="line number36 index35 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$result</code> <code class="php plain">= </code><code class="php variable">$server</code><code class="php plain">-&gt;taskCo(</code><code class="php variable">$tasks</code><code class="php plain">, </code><code class="php variable">$timeout</code><code class="php plain">);</code></p>
<p class="line number37 index36 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">App::profileEnd(</code><code class="php variable">$prifleKey</code><code class="php plain">);</code></p>
<p class="line number38 index37 alt1">&nbsp;</p>
<p class="line number39 index38 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$result</code><code class="php plain">;</code></p>
<p class="line number40 index39 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number41 index40 alt2">&nbsp;</p>
<p class="line number42 index41 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Deliver async task</code></p>
<p class="line number43 index42 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$server</code><code class="php plain">-&gt;task(</code><code class="php variable">$data</code><code class="php plain">);</code></p>
<p class="line number44 index43 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number45 index44 alt2"><code class="php plain">}</code></p>

</td>
</tr>
</tbody>
</table>
<p>任务投递<code>Task::deliver()</code>将调用参数打包后根据<code>$type</code>参数通过<code>Swoole</code>的<code>$server-&gt;taskCo()</code>或<code>$server-&gt;task()</code>接口投递到<code>Task进程</code>。<br /><code>Task</code>本身始终是同步执行的，<code>$type</code>仅仅影响投递这一操作的行为，<code>Task::TYPE_ASYNC</code>对应的<code>$server-&gt;task()</code>是异步投递，<code>Task::deliver()</code>调用后马上返回；<code>Task::TYPE_CO</code>对应的<code>$server-&gt;taskCo()</code>是协程投递，投递后让出协程控制，任务完成或执行超时后<code>Task::deliver()</code>才从协程返回。</p>
<h2>任务执行</h2>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>
<p class="line number35 index34 alt2">35</p>
<p class="line number36 index35 alt1">36</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Bootstrap\Listeners\TaskEventListener </code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* The listener of swoole task</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @SwooleListener({</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*&nbsp;&nbsp;&nbsp;&nbsp; SwooleEvent::ON_TASK,</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*&nbsp;&nbsp;&nbsp;&nbsp; SwooleEvent::ON_FINISH,</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* })</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number9 index8 alt2"><code class="php keyword">class</code> <code class="php plain">TaskEventListener </code><code class="php keyword">implements</code> <code class="php plain">TaskInterface, FinishInterface</code></p>
<p class="line number10 index9 alt1"><code class="php plain">{</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/**</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param \Swoole\Server $server</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $taskId</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $workerId</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param mixed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $data</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @return mixed</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @throws \InvalidArgumentException</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">onTask(Server </code><code class="php variable">$server</code><code class="php plain">, int </code><code class="php variable">$taskId</code><code class="php plain">, int </code><code class="php variable">$workerId</code><code class="php plain">, </code><code class="php variable">$data</code><code class="php plain">)</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">try</code> <code class="php plain">{</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/* @var TaskExecutor $taskExecutor*/</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$taskExecutor</code> <code class="php plain">= App::getBean(TaskExecutor::</code><code class="php keyword">class</code><code class="php plain">);</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$result</code> <code class="php plain">= </code><code class="php variable">$taskExecutor</code><code class="php plain">-&gt;run(</code><code class="php variable">$data</code><code class="php plain">);</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">} </code><code class="php keyword">catch</code> <code class="php plain">(\Throwable </code><code class="php variable">$throwable</code><code class="php plain">) {</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">App::error(sprintf(</code><code class="php string">'TaskExecutor-&gt;run %s file=%s line=%d '</code><code class="php plain">, </code><code class="php variable">$throwable</code><code class="php plain">-&gt;getMessage(), </code><code class="php variable">$throwable</code><code class="php plain">-&gt;getFile(), </code><code class="php variable">$throwable</code><code class="php plain">-&gt;getLine()));</code></p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$result</code> <code class="php plain">= false;</code></p>
<p class="line number28 index27 alt1">&nbsp;</p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Release system resources</code></p>
<p class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">App::trigger(AppEvent::RESOURCE_RELEASE);</code></p>
<p class="line number31 index30 alt2">&nbsp;</p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">App::trigger(TaskEvent::AFTER_TASK);</code></p>
<p class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number34 index33 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$result</code><code class="php plain">;</code></p>
<p class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number36 index35 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>此处是<code>swoole.onTask</code>的事件回调，其职责仅仅是将将<code>Worker</code>进程投递来的打包后的数据转发给<code>TaskExecutor</code>。</p>
<p><code>Swoole</code>的<code>Task</code>机制的本质是<code>Worker进程</code>将耗时任务投递给同步的<code>Task进程</code>(又名<code>TaskWorker</code>)处理,所以<code>swoole.onTask</code>的事件回调是在<code>Task进程</code>中执行的。上文说过,<code>Worker进程</code>是你大部分<code>HTTP</code>服务代码执行的环境，但是从<code>TaskEventListener.onTask()</code>方法开始，代码的执行环境都是<code>Task进程</code>，也就是说，<code>TaskExecutor</code>和具体的<code>TaskBean</code>都是执行在<code>Task进程</code>中的。</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>
<p class="line number35 index34 alt2">35</p>
<p class="line number36 index35 alt1">36</p>
<p class="line number37 index36 alt2">37</p>
<p class="line number38 index37 alt1">38</p>
<p class="line number39 index38 alt2">39</p>
<p class="line number40 index39 alt1">40</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\TaskExecutor</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* The task executor</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @Bean()</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number7 index6 alt2"><code class="php keyword">class</code> <code class="php plain">TaskExecutor</code></p>
<p class="line number8 index7 alt1"><code class="php plain">{</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/**</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param string $data</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @return mixed</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">run(string </code><code class="php variable">$data</code><code class="php plain">)</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$data</code> <code class="php plain">= TaskHelper::unpack(</code><code class="php variable">$data</code><code class="php plain">);</code></p>
<p class="line number16 index15 alt1">&nbsp;</p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$name</code>&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'name'</code><code class="php plain">];</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$type</code>&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'type'</code><code class="php plain">];</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$method</code> <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'method'</code><code class="php plain">];</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$params</code> <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'params'</code><code class="php plain">];</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$logid</code>&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'logid'</code><code class="php plain">] ?? uniqid(</code><code class="php string">''</code><code class="php plain">, true);</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$spanid</code> <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'spanid'</code><code class="php plain">] ?? 0;</code></p>
<p class="line number23 index22 alt2">&nbsp;</p>
<p class="line number24 index23 alt1">&nbsp;</p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$collector</code> <code class="php plain">= TaskCollector::getCollector();</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(!isset(</code><code class="php variable">$collector</code><code class="php plain">[</code><code class="php string">'task'</code><code class="php plain">][</code><code class="php variable">$name</code><code class="php plain">])) {</code></p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">false;</code></p>
<p class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number29 index28 alt2">&nbsp;</p>
<p class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">list(, </code><code class="php variable">$coroutine</code><code class="php plain">) = </code><code class="php variable">$collector</code><code class="php plain">[</code><code class="php string">'task'</code><code class="php plain">][</code><code class="php variable">$name</code><code class="php plain">];</code></p>
<p class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$task</code> <code class="php plain">= App::getBean(</code><code class="php variable">$name</code><code class="php plain">);</code></p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$coroutine</code><code class="php plain">) {</code></p>
<p class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$result</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;runCoTask(</code><code class="php variable">$task</code><code class="php plain">, </code><code class="php variable">$method</code><code class="php plain">, </code><code class="php variable">$params</code><code class="php plain">, </code><code class="php variable">$logid</code><code class="php plain">, </code><code class="php variable">$spanid</code><code class="php plain">, </code><code class="php variable">$name</code><code class="php plain">, </code><code class="php variable">$type</code><code class="php plain">);</code></p>
<p class="line number34 index33 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">} </code><code class="php keyword">else</code> <code class="php plain">{</code></p>
<p class="line number35 index34 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$result</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;runSyncTask(</code><code class="php variable">$task</code><code class="php plain">, </code><code class="php variable">$method</code><code class="php plain">, </code><code class="php variable">$params</code><code class="php plain">, </code><code class="php variable">$logid</code><code class="php plain">, </code><code class="php variable">$spanid</code><code class="php plain">, </code><code class="php variable">$name</code><code class="php plain">, </code><code class="php variable">$type</code><code class="php plain">);</code></p>
<p class="line number36 index35 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number37 index36 alt2">&nbsp;</p>
<p class="line number38 index37 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$result</code><code class="php plain">;</code></p>
<p class="line number39 index38 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number40 index39 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>任务执行思路很简单，将<code>Worker进程</code>发过来的数据解包还原成原来的调用参数，根据<code>$name</code>参数找到对应的<code>TaskBean</code>并调用其对应的<code>task()</code>方法。其中<code>TaskBean</code>使用类级别注解<code>@Task(name="TaskName")</code>或者<code>@Task("TaskName")</code>声明。</p>
<p>值得一提的一点是，<code>@Task</code>注解除了<code>name</code>属性，还有一个<code>coroutine</code>属性，上述代码会根据该参数选择使用协程的<code>runCoTask()</code>或者同步的<code>runSyncTask()</code>执行<code>Task</code>。但是由于而且由于<code>Swoole</code>的<code>Task进程</code>的执行是完全同步的，不支持协程，所以目前版本请该参数不要配置为<code>true</code>。同样的在<code>TaskBean</code>中编写的任务代码必须的同步阻塞的或者是要能根据环境自动将异步非阻塞和协程降级为同步阻塞的</p>
<h3>从Process中投递任务</h3>
<p>前面我们提到：</p>
<blockquote><code>Swoole</code>的<code>Task</code>机制的本质是<code>Worker进程</code>将耗时任务投递给同步的<code>Task进程</code>(又名&nbsp;<code>TaskWorker</code>)处理。</blockquote>
<p>换句话说，<code>Swoole</code>的<code>$server-&gt;taskCo()</code>或<code>$server-&gt;task()</code>都只能在<code>Worker进程</code>中使用。<br />这个限制大大的限制了使用场景。 如何能够为了能够在<code>Process</code>中投递任务呢？<code>Swoft</code>为了绕过这个限制提供了<code>Task::deliverByProcess()</code>方法。其实现原理也很简单，通过<code>Swoole</code>的<code>$server-&gt;sendMessage()</code>方法将调用信息从<code>Process</code>中投递到<code>Worker进程</code>中，然后由Worker进程替其投递到<code>Task进程</code>当中，相关代码如下：</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Task.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* Deliver task by process</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param string $taskName</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param string $methodName</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param array&nbsp; $params</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param string $type</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp; $timeout</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp; $workId</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @return bool</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number14 index13 alt1"><code class="php keyword">public</code> <code class="php keyword">static</code> <code class="php keyword">function</code> <code class="php plain">deliverByProcess(string </code><code class="php variable">$taskName</code><code class="php plain">, string </code><code class="php variable">$methodName</code><code class="php plain">, </code><code class="php keyword">array</code> <code class="php variable">$params</code> <code class="php plain">= [], int </code><code class="php variable">$timeout</code> <code class="php plain">= 3, int </code><code class="php variable">$workId</code> <code class="php plain">= 0, string </code><code class="php variable">$type</code> <code class="php plain">= self::TYPE_ASYNC): bool</code></p>
<p class="line number15 index14 alt2"><code class="php plain">{</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/* @var PipeMessageInterface $pipeMessage */</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">= App::</code><code class="php variable">$server</code><code class="php plain">-&gt;getServer();</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$pipeMessage</code> <code class="php plain">= App::getBean(PipeMessage::</code><code class="php keyword">class</code><code class="php plain">);</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$data</code> <code class="php plain">= [</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'name'</code>&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$taskName</code><code class="php plain">,</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'method'</code>&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$methodName</code><code class="php plain">,</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'params'</code>&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$params</code><code class="php plain">,</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'timeout'</code> <code class="php plain">=&gt; </code><code class="php variable">$timeout</code><code class="php plain">,</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'type'</code>&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$type</code><code class="php plain">,</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">];</code></p>
<p class="line number26 index25 alt1">&nbsp;</p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$message</code> <code class="php plain">= </code><code class="php variable">$pipeMessage</code><code class="php plain">-&gt;pack(PipeMessage::MESSAGE_TYPE_TASK, </code><code class="php variable">$data</code><code class="php plain">);</code></p>
<p class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php variable">$server</code><code class="php plain">-&gt;sendMessage(</code><code class="php variable">$message</code><code class="php plain">, </code><code class="php variable">$workId</code><code class="php plain">);</code></p>
<p class="line number29 index28 alt2"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>数据打包后使用<code>$server-&gt;sendMessage()</code>投递给<code>Worker</code>:</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Bootstrap\Server\ServerTrait.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* onPipeMessage event callback</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param \Swoole\Server $server</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $srcWorkerId</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $message</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @return void</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @throws \InvalidArgumentException</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number11 index10 alt2"><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">onPipeMessage(Server </code><code class="php variable">$server</code><code class="php plain">, int </code><code class="php variable">$srcWorkerId</code><code class="php plain">, string </code><code class="php variable">$message</code><code class="php plain">)</code></p>
<p class="line number12 index11 alt1"><code class="php plain">{</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/* @var PipeMessageInterface $pipeMessage */</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$pipeMessage</code> <code class="php plain">= App::getBean(PipeMessage::</code><code class="php keyword">class</code><code class="php plain">);</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">list(</code><code class="php variable">$type</code><code class="php plain">, </code><code class="php variable">$data</code><code class="php plain">) = </code><code class="php variable">$pipeMessage</code><code class="php plain">-&gt;unpack(</code><code class="php variable">$message</code><code class="php plain">);</code></p>
<p class="line number16 index15 alt1">&nbsp;</p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">App::trigger(AppEvent::PIPE_MESSAGE, null, </code><code class="php variable">$type</code><code class="php plain">, </code><code class="php variable">$data</code><code class="php plain">, </code><code class="php variable">$srcWorkerId</code><code class="php plain">);</code></p>
<p class="line number18 index17 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p><code>$server-&gt;sendMessage</code>后,<code>Worker进程</code>收到数据时会触发一个<code>swoole.pipeMessage</code>事件的回调，<code>Swoft</code>会将其转换成自己的<code>swoft.pipeMessage</code>事件并触发.</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Event\Listeners\PipeMessageListener.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* The pipe message listener</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @Listener(event=AppEvent::PIPE_MESSAGE)</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number7 index6 alt2"><code class="php keyword">class</code> <code class="php plain">PipeMessageListener </code><code class="php keyword">implements</code> <code class="php plain">EventHandlerInterface</code></p>
<p class="line number8 index7 alt1"><code class="php plain">{</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/**</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param \Swoft\Event\EventInterface $event</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">handle(EventInterface </code><code class="php variable">$event</code><code class="php plain">)</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$params</code> <code class="php plain">= </code><code class="php variable">$event</code><code class="php plain">-&gt;getParams();</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php functions">count</code><code class="php plain">(</code><code class="php variable">$params</code><code class="php plain">) &lt; 3) {</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code><code class="php plain">;</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number18 index17 alt1">&nbsp;</p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">list(</code><code class="php variable">$type</code><code class="php plain">, </code><code class="php variable">$data</code><code class="php plain">, </code><code class="php variable">$srcWorkerId</code><code class="php plain">) = </code><code class="php variable">$params</code><code class="php plain">;</code></p>
<p class="line number20 index19 alt1">&nbsp;</p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$type</code> <code class="php plain">!= PipeMessage::MESSAGE_TYPE_TASK) {</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code><code class="php plain">;</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number24 index23 alt1">&nbsp;</p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$type</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'type'</code><code class="php plain">];</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$taskName</code>&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'name'</code><code class="php plain">];</code></p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$params</code>&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'params'</code><code class="php plain">];</code></p>
<p class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$timeout</code>&nbsp;&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'timeout'</code><code class="php plain">];</code></p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$methodName</code> <code class="php plain">= </code><code class="php variable">$data</code><code class="php plain">[</code><code class="php string">'method'</code><code class="php plain">];</code></p>
<p class="line number30 index29 alt1">&nbsp;</p>
<p class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// delever task</code></p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">Task::deliver(</code><code class="php variable">$taskName</code><code class="php plain">, </code><code class="php variable">$methodName</code><code class="php plain">, </code><code class="php variable">$params</code><code class="php plain">, </code><code class="php variable">$type</code><code class="php plain">, </code><code class="php variable">$timeout</code><code class="php plain">);</code></p>
<p class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number34 index33 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p><code>swoft.pipeMessage</code>事件最终由<code>PipeMessageListener</code>处理。在相关的监听其中，如果发现<code>swoft.pipeMessage</code>事件由<code>Task::deliverByProcess()</code>产生的，<code>Worker进程</code>会替其执行一次<code>Task::deliver()</code>，最终将任务数据投递到<code>TaskWorker进程</code>中。</p>
<p>一道简单的回顾练习：从<code>Task::deliverByProcess()</code>到某<code>TaskBean</code>&nbsp;最终执行任务，经历了哪些进程，而调用链的哪些部分又分别是在哪些进程中执行？</p>
<h3>从Command进程或其子进程中投递任务</h3>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\QueueTask.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param string $data</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp; $taskWorkerId</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param int&nbsp;&nbsp;&nbsp; $srcWorkerId</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @return bool</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number9 index8 alt2"><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">deliver(string </code><code class="php variable">$data</code><code class="php plain">, int </code><code class="php variable">$taskWorkerId</code> <code class="php plain">= null, </code><code class="php variable">$srcWorkerId</code> <code class="php plain">= null)</code></p>
<p class="line number10 index9 alt1"><code class="php plain">{</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$taskWorkerId</code> <code class="php plain">=== null) {</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$taskWorkerId</code> <code class="php plain">= mt_rand(</code><code class="php variable">$this</code><code class="php plain">-&gt;workerNum + 1, </code><code class="php variable">$this</code><code class="php plain">-&gt;workerNum + </code><code class="php variable">$this</code><code class="php plain">-&gt;taskNum);</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number14 index13 alt1">&nbsp;</p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(</code><code class="php variable">$srcWorkerId</code> <code class="php plain">=== null) {</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$srcWorkerId</code> <code class="php plain">= mt_rand(0, </code><code class="php variable">$this</code><code class="php plain">-&gt;workerNum - 1);</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number18 index17 alt1">&nbsp;</p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;check();</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$data</code>&nbsp;&nbsp; <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;pack(</code><code class="php variable">$data</code><code class="php plain">, </code><code class="php variable">$srcWorkerId</code><code class="php plain">);</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$result</code> <code class="php plain">= \msg_send(</code><code class="php variable">$this</code><code class="php plain">-&gt;queueId, </code><code class="php variable">$taskWorkerId</code><code class="php plain">, </code><code class="php variable">$data</code><code class="php plain">, false);</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(!</code><code class="php variable">$result</code><code class="php plain">) {</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">false;</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number25 index24 alt2">&nbsp;</p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">true;</code></p>
<p class="line number27 index26 alt2"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p>对于<code>Command</code>进程的任务投递，情况会更复杂一点。<br />上文提到的<code>Process</code>，其往往衍生于<code>Http/Rpc</code>服务，作为同一个<code>Manager</code>的子孙进程，他们能够拿到<code>Swoole\Server</code>的句柄变量，从而通过<code>$server-&gt;sendMessage()</code>,<code>$server-&gt;task()</code>等方法进行任务投递。</p>
<p>但在<code>Swoft</code>的体系中，还有一个十分路人的角色：&nbsp;<code>Command</code>。<br /><code>Command</code>的进程从<code>shell</code>或<code>cronb</code>独立启动，和<code>Http/Rpc</code>服务相关的进程没有亲缘关系。因此<code>Command</code>进程以及从<code>Command</code>中启动的<code>Process</code>进程是没有办法拿到<code>Swoole\Server</code>的调用句柄直接通过<code>UnixSocket</code>进行任务投递的。<br />为了为这种进程提供任务投递支持，<code>Swoft</code>利用了<code>Swoole</code>的<code>Task进程</code>的一个特殊功能----消息队列。</p>
<p><img title="使用消息队列的Task进程.png" src="./images/Swoft源码之Swoole和Swoft的分析0.jpg" alt="使用消息队列的Task进程.png" /></p>
<p>同一个项目中<code>Command</code>和<code>Http\RpcServer</code>&nbsp;通过约定一个<code>message_queue_key</code>获取到系统内核中的同一条消息队列，然后<code>Comand</code>进程就可以通过该消息队列向<code>Task进程</code>投递任务了。<br />该机制没有提供对外的公开方法，仅仅被包含在<code>Task::deliver()</code>方法中，<code>Swoft</code>会根据当前环境隐式切换投递方式。但该消息队列的实现依赖<code>Semaphore</code>拓展，如果你想使用，需要在编译<code>PHP</code>时加上<code>--enable-sysvmsg</code>参数。</p>
<h2>定时任务</h2>
<p>除了手动执行的普通任务，<code>Swoft</code>还提供了精度为秒的定时任务功能用来在项目中替代Linux的<code>Crontab</code>功能.</p>
<p><code>Swoft</code>用两个前置<code>Process</code>---任务计划进程：<code>CronTimerProcess</code>和任务执行进程<code>CronExecProcess</code><br />，和两张内存数据表-----<code>RunTimeTable</code>（任务(配置)表）<code>OriginTable</code>（（任务）执行表）用于定时任务的管理调度。<br />两张表的每行记录的结构如下:</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php plain">\\Swoft\Task\Crontab\TableCrontab.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* 任务表，记录用户配置的任务信息</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* 表每行记录包含的字段如下,其中`rule`,`taskClass`,`taskMethod`生成key唯一确定一条记录</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @var array $originStruct </code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number7 index6 alt2"><code class="php keyword">private</code> <code class="php variable">$originStruct</code> <code class="php plain">= [</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'rule'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 100],</code><code class="php comments">//定时任务执行规则，对应@Scheduled注解的cron属性</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'taskClass'</code>&nbsp; <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 255],</code><code class="php comments">//任务名 对应@Task的name属性(默认为类名)</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'taskMethod'</code> <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 255],</code><code class="php comments">//Task方法，对应@Scheduled注解所在方法</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'add_time'</code>&nbsp;&nbsp; <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 11],</code><code class="php comments">//初始化该表内容时的10位时间戳</code></p>
<p class="line number12 index11 alt1"><code class="php plain">];</code></p>
<p class="line number13 index12 alt2">&nbsp;</p>
<p class="line number14 index13 alt1"><code class="php comments">/**</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* 执行表，记录短时间内要执行的任务列表及其执行状态</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* 表每行记录包含的字段如下,其中`taskClass`,`taskMethod`,`minute`,`sec`生成key唯一确定一条记录</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @var array $runTimeStruct </code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number19 index18 alt2"><code class="php keyword">private</code> <code class="php variable">$runTimeStruct</code> <code class="php plain">= [</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'taskClass'</code>&nbsp; <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 255],</code><code class="php comments">//同上</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'taskMethod'</code> <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 255],</code><code class="php comments">//同上</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'minute'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 20],</code><code class="php comments">//需要执行任务的时间，精确到分钟 格式date('YmdHi')</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'sec'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; [\Swoole\Table::TYPE_STRING, 20],</code><code class="php comments">//需要执行任务的时间，精确到分钟 10位时间戳</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'runStatus'</code>&nbsp; <code class="php plain">=&gt; [\Swoole\TABLE::TYPE_INT, 4],</code><code class="php comments">//任务状态，有 0(未执行)&nbsp; 1(已执行)&nbsp; 2（执行中） 三种。 </code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//注意：这里的执行是一个容易误解的地方，此处的执行并不是指任务本身的执行，而是值`任务投递`这一操作的执行，从宏观上看换成 _未投递_,_已投递_，_投递中_描述会更准确。</code></p>
<p class="line number26 index25 alt1"><code class="php plain">];</code></p>





</td>


</tr>


</tbody>


</table>
<h3>此处为何要使用Swoole的内存Table?</h3>
<p><code>Swoft</code>的的定时任务管理是分别由&nbsp;<strong>任务计划进程</strong>&nbsp;和&nbsp;<strong>任务执行进程</strong>&nbsp;进程负责的。两个进程的运行共同管理定时任务，如果使用进程间独立的<code>array()</code>等结构，两个进程必然需要频繁的进程间通信。而使用跨进程的<code>Table</code>(本文的<code>Table</code>,除非特别说明，都指<code>Swoole</code>的<code>Swoole\Table</code>结构)直接进行进程间数据共享，不仅性能高，操作简单 还解耦了两个进程。</p>
<p>为了<code>Table</code>能够在两个进程间共同使用,<code>Table</code>必须在<code>Swoole Server</code>启动前创建并分配内存。具体代码在<code>Swoft\Task\Bootstrap\Listeners-&gt;onBeforeStart()</code>中，比较简单，有兴趣的可以自行阅读。</p>
<p>背景介绍完了，我们来看看这两个定时任务进程的行为</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Bootstrap\Process\CronTimerProcess.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* Crontab timer process</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @Process(name="cronTimer", boot=true)</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number7 index6 alt2"><code class="php keyword">class</code> <code class="php plain">CronTimerProcess </code><code class="php keyword">implements</code> <code class="php plain">ProcessInterface</code></p>
<p class="line number8 index7 alt1"><code class="php plain">{</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/**</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param \Swoft\Process\Process $process</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">run(SwoftProcess </code><code class="php variable">$process</code><code class="php plain">)</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">//code....</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/* @var \Swoft\Task\Crontab\Crontab $cron*/</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$cron</code> <code class="php plain">= App::getBean(</code><code class="php string">'crontab'</code><code class="php plain">);</code></p>
<p class="line number17 index16 alt2">&nbsp;</p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Swoole/HttpServer</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code> <code class="php plain">= App::</code><code class="php variable">$server</code><code class="php plain">-&gt;getServer();</code></p>
<p class="line number20 index19 alt1">&nbsp;</p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$time</code> <code class="php plain">= (60 - </code><code class="php functions">date</code><code class="php plain">(</code><code class="php string">'s'</code><code class="php plain">)) * 1000;</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code><code class="php plain">-&gt;after(</code><code class="php variable">$time</code><code class="php plain">, </code><code class="php keyword">function</code> <code class="php plain">() </code><code class="php keyword">use</code> <code class="php plain">(</code><code class="php variable">$server</code><code class="php plain">, </code><code class="php variable">$cron</code><code class="php plain">) {</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Every minute check all tasks, and prepare the tasks that next execution point needs</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$cron</code><code class="php plain">-&gt;checkTask();</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code><code class="php plain">-&gt;tick(60 * 1000, </code><code class="php keyword">function</code> <code class="php plain">() </code><code class="php keyword">use</code> <code class="php plain">(</code><code class="php variable">$cron</code><code class="php plain">) {</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$cron</code><code class="php plain">-&gt;checkTask();</code></p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">});</code></p>
<p class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">});</code></p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number30 index29 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Crontab\Crontab.php</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* 初始化runTimeTable数据</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @param array $task&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 任务</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">* @param array $parseResult 解析crontab命令规则结果，即Task需要在当前分钟内的哪些秒执行</code></p>
<p class="line number7 index6 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @return bool</code></p>
<p class="line number8 index7 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number9 index8 alt2"><code class="php keyword">private</code> <code class="php keyword">function</code> <code class="php plain">initRunTimeTableData(</code><code class="php keyword">array</code> <code class="php variable">$task</code><code class="php plain">, </code><code class="php keyword">array</code> <code class="php variable">$parseResult</code><code class="php plain">): bool</code></p>
<p class="line number10 index9 alt1"><code class="php plain">{</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$runTimeTableTasks</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getRunTimeTable()-&gt;table;</code></p>
<p class="line number12 index11 alt1">&nbsp;</p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$min</code> <code class="php plain">= </code><code class="php functions">date</code><code class="php plain">(</code><code class="php string">'YmdHi'</code><code class="php plain">);</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$sec</code> <code class="php plain">= </code><code class="php functions">strtotime</code><code class="php plain">(</code><code class="php functions">date</code><code class="php plain">(</code><code class="php string">'Y-m-d H:i'</code><code class="php plain">));</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">foreach</code> <code class="php plain">(</code><code class="php variable">$parseResult</code> <code class="php keyword">as</code> <code class="php variable">$time</code><code class="php plain">) {</code></p>
<p class="line number16 index15 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$this</code><code class="php plain">-&gt;checkTaskQueue(false);</code></p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$key</code> <code class="php plain">= </code><code class="php variable">$this</code><code class="php plain">-&gt;getKey(</code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'rule'</code><code class="php plain">], </code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'taskClass'</code><code class="php plain">], </code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'taskMethod'</code><code class="php plain">], </code><code class="php variable">$min</code><code class="php plain">, </code><code class="php variable">$time</code> <code class="php plain">+ </code><code class="php variable">$sec</code><code class="php plain">);</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$runTimeTableTasks</code><code class="php plain">-&gt;set(</code><code class="php variable">$key</code><code class="php plain">, [</code></p>
<p class="line number19 index18 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'taskClass'</code>&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'taskClass'</code><code class="php plain">],</code></p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'taskMethod'</code> <code class="php plain">=&gt; </code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'taskMethod'</code><code class="php plain">],</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'minute'</code>&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$min</code><code class="php plain">,</code></p>
<p class="line number22 index21 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'sec'</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="php plain">=&gt; </code><code class="php variable">$time</code> <code class="php plain">+ </code><code class="php variable">$sec</code><code class="php plain">,</code></p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'runStatus'</code>&nbsp; <code class="php plain">=&gt; self::NORMAL</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">]);</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number26 index25 alt1">&nbsp;</p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">return</code> <code class="php plain">true;</code></p>
<p class="line number28 index27 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p><code>CronTimerProcess</code>是<code>Swoft</code>的定时任务调度进程，其核心方法是<code>Crontab-&gt;initRunTimeTableData()</code>。<br />该进程使用了<code>Swoole</code>的定时器功能，通过<code>Swoole\Timer</code>在每分钟首秒时执行的回调，<code>CronTimerProcess</code>每次被唤醒后都会遍历任务表计算出当前这一分钟内的60秒分别需要执行的任务清单，写入执行表并标记为 未执行。</p>
<table class="syntaxhighlighter  php" border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<p class="line number1 index0 alt2">1</p>
<p class="line number2 index1 alt1">2</p>
<p class="line number3 index2 alt2">3</p>
<p class="line number4 index3 alt1">4</p>
<p class="line number5 index4 alt2">5</p>
<p class="line number6 index5 alt1">6</p>
<p class="line number7 index6 alt2">7</p>
<p class="line number8 index7 alt1">8</p>
<p class="line number9 index8 alt2">9</p>
<p class="line number10 index9 alt1">10</p>
<p class="line number11 index10 alt2">11</p>
<p class="line number12 index11 alt1">12</p>
<p class="line number13 index12 alt2">13</p>
<p class="line number14 index13 alt1">14</p>
<p class="line number15 index14 alt2">15</p>
<p class="line number16 index15 alt1">16</p>
<p class="line number17 index16 alt2">17</p>
<p class="line number18 index17 alt1">18</p>
<p class="line number19 index18 alt2">19</p>
<p class="line number20 index19 alt1">20</p>
<p class="line number21 index20 alt2">21</p>
<p class="line number22 index21 alt1">22</p>
<p class="line number23 index22 alt2">23</p>
<p class="line number24 index23 alt1">24</p>
<p class="line number25 index24 alt2">25</p>
<p class="line number26 index25 alt1">26</p>
<p class="line number27 index26 alt2">27</p>
<p class="line number28 index27 alt1">28</p>
<p class="line number29 index28 alt2">29</p>
<p class="line number30 index29 alt1">30</p>
<p class="line number31 index30 alt2">31</p>
<p class="line number32 index31 alt1">32</p>
<p class="line number33 index32 alt2">33</p>
<p class="line number34 index33 alt1">34</p>


</td>
<td class="code">
<src class="container">
<p class="line number1 index0 alt2"><code class="php comments">//Swoft\Task\Bootstrap\Process</code></p>
<p class="line number2 index1 alt1"><code class="php comments">/**</code></p>
<p class="line number3 index2 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* Crontab process</code></p>
<p class="line number4 index3 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*</code></p>
<p class="line number5 index4 alt2"><code class="php spaces">&nbsp;</code><code class="php comments">* @Process(name="cronExec", boot=true)</code></p>
<p class="line number6 index5 alt1"><code class="php spaces">&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number7 index6 alt2"><code class="php keyword">class</code> <code class="php plain">CronExecProcess </code><code class="php keyword">implements</code> <code class="php plain">ProcessInterface</code></p>
<p class="line number8 index7 alt1"><code class="php plain">{</code></p>
<p class="line number9 index8 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/**</code></p>
<p class="line number10 index9 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">* @param \Swoft\Process\Process $process</code></p>
<p class="line number11 index10 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">*/</code></p>
<p class="line number12 index11 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">public</code> <code class="php keyword">function</code> <code class="php plain">run(SwoftProcess </code><code class="php variable">$process</code><code class="php plain">)</code></p>
<p class="line number13 index12 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">{</code></p>
<p class="line number14 index13 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$pname</code> <code class="php plain">= App::</code><code class="php variable">$server</code><code class="php plain">-&gt;getPname();</code></p>
<p class="line number15 index14 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$process</code><code class="php plain">-&gt;name(sprintf(</code><code class="php string">'%s cronexec process'</code><code class="php plain">, </code><code class="php variable">$pname</code><code class="php plain">));</code></p>
<p class="line number16 index15 alt1">&nbsp;</p>
<p class="line number17 index16 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">/** @var \Swoft\Task\Crontab\Crontab $cron */</code></p>
<p class="line number18 index17 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$cron</code> <code class="php plain">= App::getBean(</code><code class="php string">'crontab'</code><code class="php plain">);</code></p>
<p class="line number19 index18 alt2">&nbsp;</p>
<p class="line number20 index19 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Swoole/HttpServer</code></p>
<p class="line number21 index20 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code> <code class="php plain">= App::</code><code class="php variable">$server</code><code class="php plain">-&gt;getServer();</code></p>
<p class="line number22 index21 alt1">&nbsp;</p>
<p class="line number23 index22 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$server</code><code class="php plain">-&gt;tick(0.5 * 1000, </code><code class="php keyword">function</code> <code class="php plain">() </code><code class="php keyword">use</code> <code class="php plain">(</code><code class="php variable">$cron</code><code class="php plain">) {</code></p>
<p class="line number24 index23 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$tasks</code> <code class="php plain">= </code><code class="php variable">$cron</code><code class="php plain">-&gt;getExecTasks();</code></p>
<p class="line number25 index24 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">if</code> <code class="php plain">(!</code><code class="php functions">empty</code><code class="php plain">(</code><code class="php variable">$tasks</code><code class="php plain">)) {</code></p>
<p class="line number26 index25 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php keyword">foreach</code> <code class="php plain">(</code><code class="php variable">$tasks</code> <code class="php keyword">as</code> <code class="php variable">$task</code><code class="php plain">) {</code></p>
<p class="line number27 index26 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php comments">// Diliver task</code></p>
<p class="line number28 index27 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">Task::deliverByProcess(</code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'taskClass'</code><code class="php plain">], </code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'taskMethod'</code><code class="php plain">]);</code></p>
<p class="line number29 index28 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php variable">$cron</code><code class="php plain">-&gt;finishTask(</code><code class="php variable">$task</code><code class="php plain">[</code><code class="php string">'key'</code><code class="php plain">]);</code></p>
<p class="line number30 index29 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number31 index30 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number32 index31 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">});</code></p>
<p class="line number33 index32 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php plain">}</code></p>
<p class="line number34 index33 alt1"><code class="php plain">}</code></p>





</td>


</tr>


</tbody>


</table>
<p><code>CronExecProcess</code>作为定时任务的执行者，通过<code>Swoole\Timer</code>每<code>0.5s</code>唤醒自身一次，然后把&nbsp;<code>执行表</code>&nbsp;遍历一次，挑选当下需要执行的任务，通过<code>sendMessage()</code>投递出去并更新该 任务执行表中的状态。<br />该执行进程只负责任务的投递，任务的实际实际执行仍然在<code>Task进程</code>中由<code>TaskExecutor</code>处理。</p>
<h3>定时任务的宏观执行情况如下：<img title="Swoft定时任务机制.png" src="./images/Swoft源码之Swoole和Swoft的分析1.jpg" alt="Swoft定时任务机制.png" /></h3>
<p><img src="./images/Swoft源码之Swoole和Swoft的分析2.jpg" alt="" /></p>
<p><strong>明确的学习思路能更高效的学习</strong></p>
<p><strong><img src="./images/Swoft源码之Swoole和Swoft的分析3.jpg" alt="" /></strong></p>
<p>&nbsp;</p>
<p class="block-for-right-border"><a href="https://jq.qq.com/?_wv=1027&amp;k=5Spo1ah" target="_blank"><strong>点击加入该群学习&nbsp;</strong></a></p>

</div></div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>